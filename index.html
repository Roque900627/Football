<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Pro Football Manager - Dynasty Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a; 
            color: #f0f0f0;
            transition: transform 0.3s ease;
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
        }
        .accordion-content.open {
            max-height: 1000px;
            transition: max-height 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .modal-animate {
            animation: fadeIn 0.2s ease-out forwards;
        }

        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.5); }
            70% { transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }
        .pop-animate {
            animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .player-card-select {
            transition: all 0.2s;
            cursor: pointer;
            border: 1px solid transparent;
        }
        .player-card-select:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        .player-card-select.selected {
            background-color: rgba(76, 175, 80, 0.2);
            border-color: #4caf50;
            transform: scale(1.02);
        }

        .player-card-select.unavailable {
            background-color: rgba(200, 0, 0, 0.1);
            opacity: 0.8;
            cursor: pointer;
        }
        .player-card-select.unavailable:hover {
            opacity: 1;
            background-color: rgba(200, 0, 0, 0.2);
        }

        .clickable-name {
            cursor: pointer;
            text-decoration: underline;
            text-decoration-color: transparent;
            transition: all 0.2s;
        }
        .clickable-name:hover {
            color: #4caf50;
            text-decoration-color: #4caf50;
        }

        .fut-card {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            position: relative;
            overflow: hidden;
        }
        .fut-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 60%);
            pointer-events: none;
        }
        .stat-value.gold { color: #fbbf24; text-shadow: 0 0 10px rgba(251, 191, 36, 0.3); }

        .filter-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.2s;
            background: rgba(255,255,255,0.05);
            color: #94a3b8;
        }
        .filter-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .filter-btn.active { background: #4caf50; color: white; }

        .ticker-line {
            opacity: 0;
            animation: slideIn 0.3s ease-out forwards;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background-color: #f00;
            animation: fall linear forwards;
            z-index: 100;
        }
        @keyframes fall {
            to { transform: translateY(100vh) rotate(720deg); }
        }

        .type-transfer { border-left: 4px solid #4caf50; }
        .type-injury { border-left: 4px solid #ef4444; }
        .type-match { border-left: 4px solid #3b82f6; }
        .type-info { border-left: 4px solid #94a3b8; }
        .type-award { border-left: 4px solid #fbbf24; }

        .award-badge {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #000;
            font-weight: bold;
        }

        .stat-trophy {
            background: linear-gradient(135deg, #fbbf24 20%, #f59e0b 80%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 900;
        }

        .empty-slot {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.5) 0%, rgba(15, 23, 42, 0.3) 100%);
            border: 2px dashed rgba(255, 255, 255, 0.2);
            cursor: pointer;
        }
        .empty-slot:hover {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.2) 0%, rgba(15, 23, 42, 0.3) 100%);
            border-color: rgba(76, 175, 80, 0.5);
        }

        .slot-placeholder {
            color: rgba(255, 255, 255, 0.4);
            font-size: 0.8rem;
        }

        .red-card-indicator {
            animation: pulse-red 1.5s infinite;
        }
        @keyframes pulse-red {
            0%, 100% { background-color: rgba(239, 68, 68, 0.2); }
            50% { background-color: rgba(239, 68, 68, 0.4); }
        }

        .score-pulse {
            animation: scorePulse 0.5s ease-out;
        }
        @keyframes scorePulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* Мобильная адаптация */
        @media (max-width: 820px) {
            body {
                font-size: clamp(14px, 3.5vw, 16px);
            }
            
            /* Скрытый сайдбар */
            aside {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                width: 280px;
                max-width: 85vw;
                transform: translateX(-105%);
                transition: transform 0.3s ease;
                z-index: 100;
                border-right: 1px solid #334155;
                box-shadow: 5px 0 30px rgba(0,0,0,0.5);
            }
            
            body.nav-open aside {
                transform: translateX(0);
            }
            
            /* Затемнение фона */
            .nav-backdrop {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.7);
                backdrop-filter: blur(4px);
                z-index: 99;
            }
            
            body.nav-open .nav-backdrop {
                display: block;
            }
            
            /* Кнопка меню */
            .mobile-menu-btn {
                display: flex !important;
                align-items: center;
                justify-content: center;
                min-height: 44px;
                min-width: 44px;
                background: rgba(30, 41, 59, 0.8);
                border: 1px solid #475569;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                font-size: 14px;
                padding: 0 16px;
                cursor: pointer;
            }
            
            /* Основной контент */
            main {
                width: 100% !important;
                margin-left: 0 !important;
            }
            
            /* Заголовок */
            header {
                padding: 0 16px !important;
                height: 60px !important;
                gap: 12px;
            }
            
            header h2 {
                font-size: clamp(16px, 4vw, 20px);
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            /* Кнопка "Play Week" */
            #playWeekBtn {
                min-height: 44px;
                padding: 0 20px !important;
                font-size: clamp(12px, 3vw, 14px);
                white-space: nowrap;
            }
            
            /* Контент */
            .p-8 {
                padding: 16px !important;
            }
            
            /* Карточки игроков и слоты */
            .player-card-select,
            .empty-slot {
                min-height: 44px;
            }
            
            /* Модальные окна */
            #modal-overlay > div,
            #live-match-overlay > div,
            #player-stats-overlay > div,
            #profile-overlay > div,
            #offer-overlay > div,
            #transfer-confirm-overlay > div,
            #promo-relegation-overlay > div,
            #slot-select-overlay > div,
            #season-end-overlay > div,
            #signing-overlay > div {
                width: 92vw !important;
                max-width: none !important;
                max-height: 85vh !important;
                margin: 0 !important;
                border-radius: 16px !important;
                overflow-y: auto !important;
            }
            
            /* Безопасные зоны */
            #app {
                padding-top: env(safe-area-inset-top, 0);
                padding-bottom: env(safe-area-inset-bottom, 0);
            }
            
            /* Улучшение скролла на iOS */
            .overflow-y-auto {
                -webkit-overflow-scrolling: touch;
            }
            
            /* Адаптация таблиц */
            table {
                font-size: 13px;
            }
            
            .px-6 {
                padding-left: 12px !important;
                padding-right: 12px !important;
            }
            
            .py-4 {
                padding-top: 12px !important;
                padding-bottom: 12px !important;
            }
            
            /* Тактики - двухколоночная сетка */
            .grid-cols-1.lg\:grid-cols-2 {
                grid-template-columns: 1fr !important;
                gap: 16px !important;
            }
            
            /* Матч дня */
            .gap-16 {
                gap: 32px !important;
            }
            
            .w-32 {
                width: 80px !important;
                height: 80px !important;
            }
            
            .text-3xl {
                font-size: 1.5rem !important;
            }
            
            /* Пагинация */
            .flex-col.sm\:flex-row {
                flex-direction: column !important;
                gap: 12px !important;
            }
            
            /* Кнопки фильтров */
            .flex.gap-2 {
                flex-wrap: wrap;
                gap: 8px !important;
            }
            
            .filter-btn {
                min-height: 44px;
                padding: 8px 12px;
            }
            
            /* Улучшение касаний */
            button, 
            .clickable-name, 
            .player-card-select,
            .filter-btn,
            .empty-slot {
                touch-action: manipulation;
            }
        }
        
        /* Десктопные стили */
        @media (min-width: 821px) {
            .mobile-menu-btn,
            .nav-backdrop {
                display: none !important;
            }
            
            aside {
                transform: translateX(0) !important;
            }
        }
    </style>
</head>
<body class="text-slate-200 antialiased h-screen flex overflow-hidden">

    <div class="nav-backdrop" onclick="closeMobileNav()"></div>
    
    <div id="app" class="w-full h-full flex relative"></div>

    <div id="signing-overlay" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/95 backdrop-blur-xl">
        <div class="text-center w-full max-w-4xl pop-animate relative">
            <div class="absolute inset-0 bg-gradient-to-t from-[#4caf50]/20 to-transparent blur-3xl rounded-full pointer-events-none"></div>
            
            <h1 class="text-6xl md:text-8xl font-black text-transparent bg-clip-text bg-gradient-to-r from-white via-slate-200 to-slate-500 mb-8 uppercase tracking-tighter drop-shadow-2xl">
                Welcome
            </h1>
            
            <div class="flex flex-col items-center justify-center mb-12 transform hover:scale-105 transition-transform duration-500">
                <div id="reveal-card" class="fut-card w-80 md:w-96 rounded-3xl p-8 border-4 border-[#4caf50] shadow-[0_0_50px_rgba(76,175,80,0.5)]"></div>
            </div>

            <button onclick="closeSigningReveal()" class="relative z-50 bg-white text-slate-900 hover:bg-[#4caf50] hover:text-white font-black py-4 px-12 rounded-full text-xl uppercase tracking-widest shadow-xl transition-all hover:scale-110 active:scale-95 cursor-pointer">
                Add to Squad
            </button>
        </div>
    </div>

    <div id="live-match-overlay" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-md p-4">
        <div class="bg-slate-900 border border-slate-700 rounded-xl shadow-2xl max-w-2xl w-full modal-animate flex flex-col max-h-[80vh]">
            <div class="p-6 border-b border-slate-800 flex justify-between items-center bg-slate-950 rounded-t-xl">
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-full bg-red-500 animate-pulse"></div>
                    <div class="flex flex-col">
                        <h3 class="text-white font-black text-xl uppercase tracking-widest">Match Day Live</h3>
                        <span id="live-stadium" class="text-xs text-slate-500 font-mono"></span>
                    </div>
                </div>
                <div class="text-slate-400 font-mono text-sm" id="live-timer">00'</div>
            </div>
            
            <div class="p-8 bg-slate-900 flex justify-between items-center border-b border-slate-800 relative overflow-hidden">
                <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-10"></div>
                
                <div class="text-center w-1/3 relative z-10">
                    <h2 id="live-home-name" class="text-2xl font-black text-white mb-2">HOME</h2>
                </div>
                <div class="bg-black border border-slate-700 rounded-lg px-6 py-3 text-4xl font-black text-[#4caf50] shadow-lg relative z-10">
                    <span id="live-score-home">0</span> - <span id="live-score-away">0</span>
                </div>
                <div class="text-center w-1/3 relative z-10">
                    <h2 id="live-away-name" class="text-2xl font-black text-white mb-2">AWAY</h2>
                </div>
            </div>

            <div id="live-feed" class="flex-grow overflow-y-auto p-6 space-y-3 font-mono text-sm bg-slate-950 h-64 border-b border-slate-800"></div>

            <div class="p-4 bg-slate-900 rounded-b-xl flex justify-center">
                <button id="btn-live-continue" class="hidden bg-[#4caf50] hover:bg-[#43a047] text-white font-bold py-3 px-8 rounded-lg uppercase tracking-wider shadow-lg shadow-green-900/20">
                    Full Time - View Results
                </button>
            </div>
        </div>
    </div>

    <div id="modal-overlay" class="hidden fixed inset-0 z-40 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div id="modal-content" class="bg-slate-800 border border-slate-700 rounded-xl shadow-2xl max-w-md w-full modal-animate overflow-hidden max-h-[90vh] flex flex-col"></div>
    </div>
    
    <div id="season-end-overlay" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/95 backdrop-blur-xl p-4">
        <div id="season-end-content" class="text-center max-w-2xl w-full modal-animate relative"></div>
    </div>

    <div id="player-stats-overlay" class="hidden fixed inset-0 z-[55] flex items-center justify-center bg-black/90 backdrop-blur-md p-4">
        <div id="player-stats-content" class="bg-slate-900 border border-slate-700 rounded-xl shadow-2xl max-w-4xl w-full modal-animate max-h-[80vh] overflow-y-auto p-6"></div>
    </div>

    <div id="profile-overlay" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-md p-4" onclick="closeProfile(event)">
        <div id="profile-content" class="modal-animate relative" onclick="event.stopPropagation()"></div>
    </div>

    <div id="offer-overlay" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-slate-800 border border-[#4caf50] rounded-xl shadow-2xl max-w-sm w-full modal-animate p-6 text-center">
            <h3 class="text-[#4caf50] font-black text-xl mb-4 uppercase tracking-widest">Transfer Offer</h3>
            <div id="offer-body" class="mb-6"></div>
            <div class="grid grid-cols-2 gap-4">
                <button id="btn-reject" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 rounded-lg">REJECT</button>
                <button id="btn-accept" class="bg-[#4caf50] hover:bg-[#43a047] text-white font-bold py-2 rounded-lg">ACCEPT</button>
            </div>
        </div>
    </div>

    <div id="transfer-confirm-overlay" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-slate-800 border border-slate-600 rounded-xl shadow-2xl max-w-md w-full modal-animate p-6">
            <h3 class="text-white font-black text-xl mb-4 uppercase tracking-widest border-b border-slate-700 pb-2">Confirm Transfer</h3>
            
            <div class="text-slate-300 mb-6 text-sm">
                Are you sure you want to sign <span id="tc-player-name" class="font-bold text-white"></span> from <span id="tc-club-name" class="font-bold text-white"></span>?
            </div>

            <div class="bg-slate-900/50 rounded-lg p-4 mb-6 font-mono text-sm space-y-2 border border-slate-700/50">
                <div class="flex justify-between items-center">
                    <span class="text-slate-400">Current Budget</span>
                    <span id="tc-current-budget" class="text-emerald-400 font-bold"></span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-slate-400">Transfer Fee</span>
                    <span id="tc-transfer-fee" class="text-red-400 font-bold"></span>
                </div>
                <div class="h-px bg-slate-700 my-2"></div>
                <div class="flex justify-between items-center text-base">
                    <span class="text-white font-bold">Remaining</span>
                    <span id="tc-remaining" class="font-bold"></span>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <button onclick="closeTransferModal()" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 rounded-lg uppercase tracking-wider text-xs">Cancel</button>
                <button id="btn-confirm-transfer" class="bg-[#4caf50] hover:bg-[#43a047] text-white font-bold py-3 rounded-lg uppercase tracking-wider text-xs shadow-lg shadow-green-900/20">Confirm Signing</button>
            </div>
        </div>
    </div>

    <div id="promo-relegation-overlay" class="hidden fixed inset-0 z-[70] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-slate-800 border border-slate-600 rounded-xl shadow-2xl max-w-md w-full modal-animate p-6">
            <h3 id="pr-title" class="text-white font-black text-xl mb-4 uppercase tracking-widest border-b border-slate-700 pb-2"></h3>
            
            <div class="text-slate-300 mb-6 text-sm text-center" id="pr-message">
                
            </div>

            <div class="bg-slate-900/50 rounded-lg p-4 mb-6 font-mono text-sm space-y-2 border border-slate-700/50" id="pr-details">
                
            </div>

            <div class="flex justify-center">
                <button id="btn-pr-continue" class="bg-[#4caf50] hover:bg-[#43a047] text-white font-bold py-3 px-8 rounded-lg uppercase tracking-wider text-sm shadow-lg shadow-green-900/20">
                    CONTINUE
                </button>
            </div>
        </div>
    </div>

    <div id="slot-select-overlay" class="hidden fixed inset-0 z-[75] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="bg-slate-800 border border-slate-600 rounded-xl shadow-2xl max-w-md w-full modal-animate p-6">
            <h3 id="slot-select-title" class="text-white font-black text-xl mb-4 uppercase tracking-widest border-b border-slate-700 pb-2"></h3>
            
            <div class="mb-6 text-slate-300 text-sm" id="slot-select-subtitle">
                Select a player to fill the empty slot:
            </div>

            <div id="slot-select-players" class="max-h-96 overflow-y-auto space-y-2 mb-6">
            </div>

            <div class="flex justify-between">
                <button onclick="document.getElementById('slot-select-overlay').classList.add('hidden')" 
                        class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-6 rounded-lg">
                    Cancel
                </button>
                <div class="text-sm text-slate-400 self-center" id="slot-select-count">
                    0 players available
                </div>
            </div>
        </div>
    </div>

    <script>
        let SQL;
        window.initSqlJs({
            locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
        }).then(function(s){
            SQL = s;
            console.log("SQL.js initialized");
        });

        const STATE = {
            loaded: false,
            season: 1,
            history: [],
            newsFeed: [],
            allTeams: [],
            activeLeagueTeams: [],
            schedule: [],
            currentWeek: 0,
            userTeamId: null,
            totalWeeks: 0,
            view: 'next-match', 
            swapSelection: null,
            market: {
                posFilter: 'ALL',
                sort: 'RATING',
                search: '',
                page: 1,
                perPage: 50
            },
            leagueStats: {
                topScorers: [],
                topAssists: [],
                bestPlayers: [],
                awardsHistory: []
            },
            leaguesMap: new Map(),
            userLineupSlots: Array(11).fill(null),
            slotSelection: null,
            matchRedCards: new Map()
        };

        let pendingTransfer = null;

        const POS_PRIORITY = {
            'GK': 1,
            'LB': 2, 'RB': 2, 'CB': 2, 'DF': 2, 'DEF': 2, 'LWB': 2, 'RWB': 2,
            'CDM': 3, 'CM': 3, 'CAM': 3, 'LM': 3, 'RM': 3, 'MF': 3, 'MID': 3,
            'LW': 4, 'RW': 4, 'ST': 4, 'CF': 4, 'FW': 4, 'FWD': 4
        };

        const POS_SCORING_WEIGHT = {
            4: 15,
            3: 4,
            2: 1,
            1: 0
        };

        const BASE_INJURY_CHANCE = 0.02;
        const INJURY_REDUCTION = 0.05;
        const INJURY_CHANCE = Math.max(0, BASE_INJURY_CHANCE - INJURY_REDUCTION);

        const PRICE_GROWTH_PER_RATING = 0.08;

        const RED_CARD_TEAM_PENALTY = 0.80;
        const RED_CARD_OPPONENT_BOOST = 1.10;

        const POTENTIAL_SYSTEM = {
            YOUNG_MAX_BOOST: 12,
            PRIME_MAX_BOOST: 6,
            MATURE_MAX_BOOST: 3,
            OLD_MAX_BOOST: 1,
            SUPERSTAR_THRESHOLD: 97,
            STAR_THRESHOLD: 95,
            GOOD_THRESHOLD: 90,
            REGULAR_THRESHOLD: 85,
            SUPERSTAR_CHANCE: 0.005,
            STAR_CHANCE: 0.02,
            GOOD_CHANCE: 0.1,
            YOUNG_GROWTH_RATE: 0.8,
            PRIME_GROWTH_RATE: 0.3,
            MATURE_GROWTH_RATE: 0.1,
            OLD_DECLINE_RATE: -0.3,
            VET_DECLINE_RATE: -0.8,
            STARTER_BOOST: 1.5,
            BENCH_PENALTY: 0.5,
            INJURY_DECLINE: -0.5,
            MIN_RATING: 40,
            MAX_RATING: 99,
            MIN_POTENTIAL: 50,
            OLD_DECLINE_CHANCE: 0.1,
            VET_DECLINE_CHANCE: 0.3
        };

        function getUserLineupSlots() {
            return STATE.userLineupSlots;
        }

        function setUserLineupSlot(slotIndex, playerId) {
            STATE.userLineupSlots[slotIndex] = playerId;
        }

        function clearUserLineupSlot(slotIndex) {
            STATE.userLineupSlots[slotIndex] = null;
        }

        function resetUserLineupSlots() {
            STATE.userLineupSlots = Array(11).fill(null);
        }

        function getSlotPositions() {
            return [
                { position: 'GK', index: 0 },
                { position: 'DEF', index: 0 },
                { position: 'DEF', index: 1 },
                { position: 'DEF', index: 2 },
                { position: 'DEF', index: 3 },
                { position: 'MID', index: 0 },
                { position: 'MID', index: 1 },
                { position: 'MID', index: 2 },
                { position: 'FWD', index: 0 },
                { position: 'FWD', index: 1 },
                { position: 'FWD', index: 2 }
            ];
        }

        function getPlayerInSlot(slotIndex) {
            const userTeam = getTeam(STATE.userTeamId);
            if (!userTeam) return null;
            
            const slotId = STATE.userLineupSlots[slotIndex];
            if (slotId === null) return null;
            
            return userTeam.squad.find(p => p.internalId === slotId);
        }

        function setPlayerInSlot(slotIndex, playerId) {
            const userTeam = getTeam(STATE.userTeamId);
            if (!userTeam) return;
            
            for (let i = 0; i < STATE.userLineupSlots.length; i++) {
                if (STATE.userLineupSlots[i] === playerId) {
                    STATE.userLineupSlots[i] = null;
                }
            }
            
            STATE.userLineupSlots[slotIndex] = playerId;
            
            updateTeamStartersFromSlots(userTeam);
            calculateTeamRating(userTeam);
        }

        function clearSlot(slotIndex) {
            const userTeam = getTeam(STATE.userTeamId);
            if (!userTeam) return;
            
            STATE.userLineupSlots[slotIndex] = null;
            updateTeamStartersFromSlots(userTeam);
            calculateTeamRating(userTeam);
        }

        function updateTeamStartersFromSlots(team) {
            team.squad.forEach(p => p.isStarter = false);
            
            STATE.userLineupSlots.forEach(slotId => {
                if (slotId !== null) {
                    const player = team.squad.find(p => p.internalId === slotId);
                    if (player) {
                        player.isStarter = true;
                    }
                }
            });
        }

        function getBenchPlayers(team) {
            const lineupIds = new Set(STATE.userLineupSlots.filter(id => id !== null));
            return team.squad.filter(p => !lineupIds.has(p.internalId));
        }

        function autoSelectBestXI(team) {
            const backupSlots = [...STATE.userLineupSlots];
            
            try {
                const newSlots = Array(11).fill(null);
                
                const available = team.squad.filter(p => p.injuryWeeks === 0 && !p.isSuspended);
                
                const gks = available.filter(p => getPosCategory(p.pos) === 1);
                const defs = available.filter(p => getPosCategory(p.pos) === 2);
                const mids = available.filter(p => getPosCategory(p.pos) === 3);
                const fwds = available.filter(p => getPosCategory(p.pos) === 4);
                
                const selectedPlayers = [];
                
                if (gks.length > 0) {
                    const bestGK = gks.sort((a, b) => b.rating - a.rating)[0];
                    selectedPlayers.push(bestGK);
                }
                
                const bestDefs = defs.sort((a, b) => b.rating - a.rating).slice(0, 4);
                selectedPlayers.push(...bestDefs);
                
                const bestMids = mids.sort((a, b) => b.rating - a.rating).slice(0, 3);
                selectedPlayers.push(...bestMids);
                
                const bestFwds = fwds.sort((a, b) => b.rating - a.rating).slice(0, 3);
                selectedPlayers.push(...bestFwds);
                
                if (selectedPlayers.length < 11) {
                    const remainingNeeded = 11 - selectedPlayers.length;
                    const selectedIds = new Set(selectedPlayers.map(p => p.internalId));
                    const sortedByRating = [...available].sort((a, b) => b.rating - a.rating);
                    const remainingPlayers = sortedByRating.filter(p => !selectedIds.has(p.internalId));
                    
                    selectedPlayers.push(...remainingPlayers.slice(0, remainingNeeded));
                }
                
                selectedPlayers.forEach((player, index) => {
                    if (index < 11) {
                        newSlots[index] = player.internalId;
                    }
                });
                
                for (let i = 0; i < 11; i++) {
                    STATE.userLineupSlots[i] = newSlots[i];
                }
                
                updateTeamStartersFromSlots(team);
                calculateTeamRating(team);
                
                return true;
            } catch (error) {
                for (let i = 0; i < 11; i++) {
                    STATE.userLineupSlots[i] = backupSlots[i];
                }
                updateTeamStartersFromSlots(team);
                calculateTeamRating(team);
                console.error("Auto-select failed:", error);
                return false;
            }
        }

        function autoSelectStarters(team) {
            if (team.id === STATE.userTeamId) {
                return;
            }
            
            const available = team.squad.filter(p => p.injuryWeeks === 0 && !p.isSuspended);
            
            const gks = available.filter(p => getPosCategory(p.pos) === 1);
            const defs = available.filter(p => getPosCategory(p.pos) === 2);
            const mids = available.filter(p => getPosCategory(p.pos) === 3);
            const fwds = available.filter(p => getPosCategory(p.pos) === 4);
            
            team.squad.forEach(p => p.isStarter = false);
            
            if (gks.length > 0) {
                const bestGK = gks.sort((a, b) => b.rating - a.rating)[0];
                bestGK.isStarter = true;
            }
            
            defs.sort((a, b) => b.rating - a.rating).slice(0, 4).forEach(p => p.isStarter = true);
            mids.sort((a, b) => b.rating - a.rating).slice(0, 3).forEach(p => p.isStarter = true);
            fwds.sort((a, b) => b.rating - a.rating).slice(0, 3).forEach(p => p.isStarter = true);
            
            calculateTeamRating(team);
        }

        function getPosCategory(pos) {
            const p = pos ? pos.toUpperCase() : '';
            return POS_PRIORITY[p] || 5;
        }

        function formatMoney(amount) {
            return new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP', maximumFractionDigits: 0 }).format(amount);
        }

        function generateColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
            return '#' + "00000".substring(0, 6 - c.length) + c;
        }

        function addNews(title, msg, type) {
            STATE.newsFeed.unshift({ title, msg, type, week: STATE.currentWeek, season: STATE.season });
            if (STATE.newsFeed.length > 50) STATE.newsFeed.pop();
        }

        function tableToObjects(tbl){
            if(!tbl || !Array.isArray(tbl.colonne) || !Array.isArray(tbl.dati)) return [];
            return tbl.dati.map(row => Object.fromEntries(tbl.colonne.map((c,i)=>[c,row[i]])));
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();

            if (file.name.endsWith('.db') || file.name.endsWith('.sqlite')) {
                reader.onload = function(e) {
                    try {
                        const u8 = new Uint8Array(e.target.result);
                        const db = new SQL.Database(u8);
                        processSqlDb(db);
                    } catch (err) {
                        alert("Error parsing Database: " + err.message);
                        console.error(err);
                    }
                };
                reader.readAsArrayBuffer(file);
            } else {
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.leagues && data.teams && data.players) {
                            processNewTableFormat(data);
                        } else if (data.clubs || data.teams) {
                            processNewJsonFormat(data);
                        } else {
                            alert("Unknown JSON format");
                        }
                    } catch (err) {
                        alert("Error parsing JSON: " + err.message);
                        console.error(err);
                    }
                };
                reader.readAsText(file);
            }
        }

        function processNewTableFormat(db) {
            console.log("Processing new table format", db);
            
            const leaguesArr = tableToObjects(db.leagues);
            const teamsArray = tableToObjects(db.teams);
            const playersArr = tableToObjects(db.players);
            
            if (teamsArray.length === 0) {
                alert("No clubs found in database");
                return;
            }
            
            STATE.leaguesMap.clear();
            
            const leagueMap = new Map();
            leaguesArr.forEach(l => {
                const id = String(l.id);
                leagueMap.set(id, {
                    name: l.name || `League ${id}`,
                    division: l.division || 1,
                    nation: l.nation || l.country || 'INT',
                    promotions: l.promotions || 3,
                    directPromotions: l.directPromotions || 3,
                    relegations: l.relegations || 3
                });
                STATE.leaguesMap.set(id, leagueMap.get(id));
            });
            
            STATE.allTeams = teamsArray.map((team, index) => {
                const teamId = Number(team.id);
                const leagueId = String(team.leagueId || 'OTHER');
                const leagueInfo = leagueMap.get(leagueId) || { 
                    name: `League ${leagueId}`,
                    division: 1,
                    nation: 'INT',
                    promotions: 3,
                    directPromotions: 3,
                    relegations: 3
                };
                
                return {
                    id: String(teamId),
                    name: team.name || `Team ${teamId}`,
                    leagueId: leagueId,
                    leagueName: leagueInfo.name,
                    stadiumName: team.stadiumName || "Municipal Stadium",
                    teamRating: 0,
                    points: 0,
                    played: 0,
                    wins: 0,
                    draws: 0,
                    losses: 0,
                    gf: 0,
                    ga: 0,
                    gd: 0,
                    budget: Number(team.teamValue || team.budget || 50000000),
                    color: team.color || generateColor(team.name || `Team ${teamId}`),
                    squad: []
                };
            });
            
            const teamById = new Map();
            STATE.allTeams.forEach(t => {
                teamById.set(Number(t.id), t);
            });
            
            let playerIndex = 0;
            playersArr.forEach((player, index) => {
                const teamId = Number(player.teamId);
                const team = teamById.get(teamId);
                
                if (team) {
                    let roles = [];
                    try {
                        if (player.roles) {
                            roles = typeof player.roles === 'string' ? JSON.parse(player.roles) : player.roles;
                        }
                    } catch(e) {
                        console.warn("Could not parse roles for player", player.name, e);
                    }
                    
                    const rating = Math.round(parseFloat(player.overall || 50));
                    const price = Number(player.marketValue || rating * 1000000);
                    let age = 20;
                    
                    if (player.birthdate) {
                        const birthYear = parseInt(player.birthdate.substring(0, 4));
                        if (!isNaN(birthYear)) {
                            age = 2024 - birthYear;
                        }
                    }
                    
                    const speed = Math.floor(rating * 0.9);
                    const shot = Math.floor(rating * 0.8);
                    const pass = Math.floor(rating * 0.85);
                    const dribble = Math.floor(rating * 0.88);
                    
                    const playerObj = {
                        internalId: playerIndex++,
                        name: (player.name || "") + " " + (player.surname || ""),
                        pos: (roles[0] && roles[0].role) || "MID",
                        rating: rating,
                        potential: rating + Math.floor(Math.random() * 10),
                        price: price,
                        clubId: String(teamId),
                        speed: speed,
                        shot: shot,
                        pass: pass,
                        dribble: dribble,
                        age: age,
                        nation: player.nationality || player.nation || "INT",
                        isStarter: false,
                        transferListed: false,
                        seasonGoals: 0,
                        seasonAssists: 0,
                        seasonRating: rating,
                        careerGoals: 0,
                        injuryWeeks: 0,
                        isSuspended: false,
                        suspensionPending: false
                    };
                    
                    team.squad.push(playerObj);
                }
            });
            
            if (db.gameState && STATE.userTeamId) {
                STATE.allTeams.forEach(team => {
                    if (team.id === STATE.userTeamId) {
                        updateTeamStartersFromSlots(team);
                    } else {
                        if (!team.squad.some(p => p.isStarter)) autoSelectStarters(team);
                    }
                    calculateTeamRating(team);
                });

                STATE.loaded = true;
                const userTeam = getTeam(STATE.userTeamId);
                if (userTeam) {
                    STATE.activeLeagueTeams = STATE.allTeams.filter(t => t.leagueId === userTeam.leagueId);
                }
                renderDashboard();
            } else {
                STATE.allTeams.forEach(team => {
                    if (team.id === STATE.userTeamId) {
                        updateTeamStartersFromSlots(team);
                    } else {
                        autoSelectStarters(team);
                    }
                    calculateTeamRating(team);
                });

                STATE.loaded = true;
                renderTeamSelection();
            }
        }

        function processSqlDb(db) {
            const resultToJson = (res) => {
                if (!res || !res.values) return [];
                const cols = res.columns.map(c => c.toLowerCase());
                return res.values.map(row => {
                    const obj = {};
                    cols.forEach((col, i) => obj[col] = row[i]);
                    return obj;
                });
            };

            const getVal = (row, keys) => {
                for(const k of keys) {
                    if (row[k] !== undefined) return row[k];
                    if (row[k.toLowerCase()] !== undefined) return row[k.toLowerCase()];
                    if (row[k.toUpperCase()] !== undefined) return row[k.toUpperCase()];
                }
                return null;
            };

            const getTable = (possibleNames) => {
                try {
                    const tables = resultToJson(db.exec("SELECT name FROM sqlite_master WHERE type='table'")[0]);
                    const tableNames = tables.map(t => t.name.toLowerCase());
                    const match = tableNames.find(n => possibleNames.includes(n));
                    if (match) return resultToJson(db.exec(`SELECT * FROM ${match}`)[0]);
                } catch(e) { console.warn("Table not found:", possibleNames); }
                return [];
            };

            const clubs = getTable(['club', 'clubs', 'team', 'teams']);
            const players = getTable(['player', 'players']);
            const competitions = getTable(['competition', 'competitions', 'league', 'leagues']);
            const stages = getTable(['competitionstage', 'competition_stage', 'stage']);
            const stageClubs = getTable(['competitionstageclub', 'competition_stage_club', 'competition_clubs']);
            const stadiums = getTable(['stadium', 'stadiums', 'grounds']);

            competitions.forEach(c => {
                const id = getVal(c, ['id', 'competitionid', 'leagueid']);
                const name = getVal(c, ['name', 'display_name', 'leaguename']);
                const division = getVal(c, ['division', 'level', 'tier']) || 1;
                const promotions = getVal(c, ['promotions', 'promotion_spots']) || 3;
                const directPromotions = getVal(c, ['direct_promotions', 'auto_promotions']) || promotions;
                const relegations = getVal(c, ['relegations', 'relegation_spots']) || 3;
                
                if (id) {
                    STATE.leaguesMap.set(String(id), {
                        name: name || `League ${id}`,
                        division: division,
                        nation: getVal(c, ['nation', 'country', 'countrycode']) || 'INT',
                        promotions: promotions,
                        directPromotions: directPromotions,
                        relegations: relegations
                    });
                }
            });

            const compMap = {};
            competitions.forEach(c => {
                const id = getVal(c, ['id', 'competitionid', 'leagueid']);
                const name = getVal(c, ['name', 'display_name', 'leaguename']);
                if (id) compMap[id] = name || `League ${id}`;
            });

            const stageToCompMap = {};
            stages.forEach(s => {
                const id = getVal(s, ['id', 'stageid']);
                const compId = getVal(s, ['competitionid', 'competition_id', 'leagueid']);
                if (id) stageToCompMap[id] = compId;
            });

            const stadiumMap = {};
            stadiums.forEach(s => {
                const id = getVal(s, ['id', 'stadiumid']);
                const name = getVal(s, ['name', 'stadiumname']);
                if (id) stadiumMap[id] = name;
            });

            const clubLeagueMap = {};
            stageClubs.forEach(sc => {
                const clubId = getVal(sc, ['clubid', 'club_id']);
                const stageId = getVal(sc, ['competitionstageid', 'competition_stage_id', 'stageid']);
                if (clubId && stageId) {
                    const compId = stageToCompMap[stageId];
                    if (compId && compMap[compId]) {
                        clubLeagueMap[clubId] = {
                            id: compId,
                            name: compMap[compId]
                        };
                    }
                }
            });

            const normalizedClubs = clubs.map(c => {
                const id = String(getVal(c, ['id', 'clubid']));
                const name = getVal(c, ['name', 'shortname', 'longname']) || "Unknown Club";
                
                const rDF = getVal(c, ['ratingdf', 'rating_df', 'def']) || 50;
                const rMF = getVal(c, ['ratingmf', 'rating_mf', 'mid']) || 50;
                const rFW = getVal(c, ['ratingfw', 'rating_fw', 'att']) || 50;
                
                const avgRating = Math.round((rDF + rMF + rFW) / 3);
                
                const leagueInfo = clubLeagueMap[id] || { id: 'OTHER', name: "Rest of World" };
                
                let stadiumId = getVal(c, ['stadiumid', 'stadium_id', 'groundid']);
                const stadiumName = stadiumMap[stadiumId] || "Municipal Stadium";

                return {
                    id: id,
                    name: name,
                    leagueId: leagueInfo.id,
                    leagueName: leagueInfo.name,
                    stadiumName: stadiumName,
                    teamRating: avgRating,
                    budget: getVal(c, ['budget', 'money']) || Math.floor(Math.random() * 50000000) + 5000000
                };
            });

            const clubIdSet = new Set(normalizedClubs.map(c => c.id));
            const normalizedPlayers = [];

            players.forEach((p, index) => {
                const cid = String(getVal(p, ['clubid', 'club_id', 'current_club_id']));
                
                if (clubIdSet.has(cid)) {
                    let rating = getVal(p, ['rating', 'overall', 'ca', 'current_ability']);
                    if (!rating) {
                        const rDF = getVal(p, ['ratingdf']) || 50;
                        const rMF = getVal(p, ['ratingmf']) || 50;
                        const rFW = getVal(p, ['ratingfw']) || 50;
                        rating = Math.max(rDF, rMF, rFW);
                    }

                    let speed = getVal(p, ['speed', 'pace', 'acceleration']) || Math.floor(rating * 0.9);
                    let shot = getVal(p, ['shot', 'shooting', 'finishing']) || Math.floor(rating * 0.8);
                    let pass = getVal(p, ['pass', 'passing']) || Math.floor(rating * 0.85);
                    let dribble = getVal(p, ['dribble', 'dribbling']) || Math.floor(rating * 0.88);

                    let age = getVal(p, ['age', 'birthyear']);
                    if (age > 1900) age = 2024 - age;
                    if (!age) age = Math.floor(Math.random() * 15) + 18;

                    let nation = getVal(p, ['nationality', 'nation', 'countrycode', 'nationname']);

                    normalizedPlayers.push({
                        internalId: index,
                        name: getVal(p, ['name', 'common_name', 'firstname', 'lastname']) || "Unknown Player",
                        pos: getVal(p, ['pos', 'position', 'best_position']) || "MID",
                        rating: rating,
                        potential: rating + Math.floor(Math.random() * 10),
                        price: getVal(p, ['price', 'value']) || rating * 1000000,
                        clubId: cid,
                        speed: speed, 
                        shot: shot,
                        pass: pass,
                        dribble: dribble,
                        age: age,
                        nation: nation,
                        isStarter: false,
                        transferListed: false,
                        seasonGoals: 0,
                        seasonAssists: 0,
                        seasonRating: rating,
                        careerGoals: 0,
                        injuryWeeks: 0,
                        isSuspended: false,
                        suspensionPending: false
                    });
                }
            });

            processData({
                clubs: normalizedClubs,
                players: normalizedPlayers
            });
        }

        function processNewJsonFormat(data) {
            console.log("Processing new JSON format", data);
            
            if (data.leagues && Array.isArray(data.leagues)) {
                data.leagues.forEach(league => {
                    const id = league.id || league.leagueId;
                    if (id) {
                        STATE.leaguesMap.set(String(id), {
                            name: league.name || league.leagueName || `League ${id}`,
                            division: league.division || league.level || 1,
                            nation: league.nation || league.country || league.countryCode || 'INT',
                            promotions: league.promotions || league.promotionSpots || 3,
                            directPromotions: league.directPromotions || league.autoPromotions || league.promotions || 3,
                            relegations: league.relegations || league.relegationSpots || 3
                        });
                    }
                });
            }
            
            let teamsArray = [];
            let playersArray = [];
            
            if (Array.isArray(data)) {
                playersArray = data;
                const teamMap = new Map();
                data.forEach(player => {
                    if (player.teamId) {
                        const teamId = String(player.teamId);
                        if (!teamMap.has(teamId)) {
                            const leagueId = player.leagueId || teamId;
                            const leagueInfo = STATE.leaguesMap.get(String(leagueId)) || {
                                name: player.leagueName || `League ${leagueId}`,
                                division: 1,
                                promotions: 3,
                                directPromotions: 3,
                                relegations: 3
                            };
                            
                            teamMap.set(teamId, {
                                id: teamId,
                                name: player.teamName || `Team ${teamId}`,
                                leagueId: leagueId,
                                leagueName: leagueInfo.name,
                                budget: player.teamValue || 50000000
                            });
                        }
                    }
                });
                teamsArray = Array.from(teamMap.values());
            } else if (data.teams && data.players) {
                teamsArray = data.teams;
                playersArray = data.players;
            } else if (data.clubs && data.players) {
                teamsArray = data.clubs;
                playersArray = data.players;
            } else {
                for (const key in data) {
                    if (Array.isArray(data[key])) {
                        const firstItem = data[key][0];
                        if (firstItem && firstItem.teamId !== undefined) {
                            playersArray = data[key];
                        } else if (firstItem && firstItem.id !== undefined) {
                            teamsArray = data[key];
                        }
                    }
                }
            }
            
            if (teamsArray.length === 0 || playersArray.length === 0) {
                alert("Invalid JSON format: Could not find teams and players data");
                return;
            }
            
            if (data.gameState) {
                STATE.season = data.gameState.season || 1;
                STATE.history = data.gameState.history || [];
                STATE.newsFeed = data.gameState.newsFeed || [];
                STATE.currentWeek = data.gameState.currentWeek;
                STATE.schedule = data.gameState.schedule;
                STATE.userTeamId = data.gameState.userTeamId ? String(data.gameState.userTeamId) : null;
                STATE.totalWeeks = STATE.schedule.length;
                STATE.leagueStats = data.gameState.leagueStats || { topScorers: [], topAssists: [], bestPlayers: [], awardsHistory: [] };
                STATE.userLineupSlots = data.gameState.userLineupSlots || Array(11).fill(null);
            } else {
                STATE.season = 1;
                STATE.history = [];
                STATE.newsFeed = [];
                STATE.userTeamId = null;
                STATE.leagueStats = { topScorers: [], topAssists: [], bestPlayers: [], awardsHistory: [] };
                STATE.userLineupSlots = Array(11).fill(null);
            }

            STATE.allTeams = teamsArray.map((team, index) => {
                const teamId = String(team.id || team.teamId || index);
                const teamName = team.name || team.teamName || `Team ${teamId}`;
                
                const leagueId = team.leagueId || team.league || teamId;
                const leagueInfo = STATE.leaguesMap.get(String(leagueId)) || {
                    name: team.leagueName || team.league || `League ${leagueId}`,
                    division: 1,
                    promotions: 3,
                    directPromotions: 3,
                    relegations: 3
                };
                
                const budget = team.budget || team.teamValue || 50000000;
                
                return {
                    id: teamId,
                    name: teamName,
                    leagueId: leagueId,
                    leagueName: leagueInfo.name,
                    stadiumName: team.stadiumName || "Municipal Stadium",
                    teamRating: 0,
                    points: 0,
                    played: 0,
                    wins: 0,
                    draws: 0,
                    losses: 0,
                    gf: 0,
                    ga: 0,
                    gd: 0,
                    budget: budget,
                    color: team.color || generateColor(teamName),
                    squad: []
                };
            });

            let playerIndex = 0;
            playersArray.forEach((player, index) => {
                const playerName = (player.name || "") + " " + (player.surname || "");
                const cleanName = playerName.trim() || `Player ${index}`;
                
                let position = "MID";
                if (player.roles && Array.isArray(player.roles) && player.roles.length > 0) {
                    position = player.roles[0].role || "MID";
                } else if (player.position) {
                    position = player.position;
                }
                
                let rating = 50;
                if (player.overall) {
                    rating = Math.round(parseFloat(player.overall));
                } else if (player.rating) {
                    rating = Math.round(parseFloat(player.rating));
                }
                
                let price = rating * 1000000;
                if (player.marketValue !== undefined) {
                    price = parseFloat(player.marketValue);
                } else if (player.price !== undefined) {
                    price = parseFloat(player.price);
                }
                
                let age = 20;
                if (player.birthdate) {
                    const birthYear = parseInt(player.birthdate.substring(0, 4));
                    if (!isNaN(birthYear)) {
                        age = 2024 - birthYear;
                    }
                } else if (player.age) {
                    age = parseInt(player.age);
                }
                
                const teamId = String(player.teamId);
                const team = STATE.allTeams.find(t => t.id === teamId);
                
                if (team) {
                    const speed = Math.floor(rating * 0.9);
                    const shot = Math.floor(rating * 0.8);
                    const pass = Math.floor(rating * 0.85);
                    const dribble = Math.floor(rating * 0.88);
                    
                    team.squad.push({
                        internalId: playerIndex++,
                        name: cleanName,
                        pos: position,
                        rating: rating,
                        potential: rating + Math.floor(Math.random() * 10),
                        price: price,
                        clubId: teamId,
                        speed: speed,
                        shot: shot,
                        pass: pass,
                        dribble: dribble,
                        age: age,
                        nation: player.nation || player.nationality || "INT",
                        isStarter: false,
                        transferListed: false,
                        seasonGoals: 0,
                        seasonAssists: 0,
                        seasonRating: rating,
                        careerGoals: 0,
                        injuryWeeks: 0,
                        isSuspended: false,
                        suspensionPending: false
                    });
                }
            });

            if (data.gameState && STATE.userTeamId) {
                STATE.allTeams.forEach(team => {
                    if (team.id === STATE.userTeamId) {
                        updateTeamStartersFromSlots(team);
                    } else {
                        if (!team.squad.some(p => p.isStarter)) autoSelectStarters(team);
                    }
                    calculateTeamRating(team);
                });

                STATE.loaded = true;
                const userTeam = getTeam(STATE.userTeamId);
                if (userTeam) {
                    STATE.activeLeagueTeams = STATE.allTeams.filter(t => t.leagueId === userTeam.leagueId);
                }
                renderDashboard();
            } else {
                STATE.allTeams.forEach(team => {
                    if (team.id === STATE.userTeamId) {
                        updateTeamStartersFromSlots(team);
                    } else {
                        autoSelectStarters(team);
                    }
                    calculateTeamRating(team);
                });

                STATE.loaded = true;
                renderTeamSelection();
            }
        }

        function processData(data) {
            if ((!data.clubs || !Array.isArray(data.clubs) || !data.players || !Array.isArray(data.players)) && !data.gameState) {
                alert("Invalid Data format.");
                return;
            }

            if (data.gameState) {
                STATE.season = data.gameState.season || 1;
                STATE.history = data.gameState.history || [];
                STATE.newsFeed = data.gameState.newsFeed || [];
                STATE.currentWeek = data.gameState.currentWeek;
                STATE.schedule = data.gameState.schedule;
                STATE.userTeamId = data.gameState.userTeamId ? String(data.gameState.userTeamId) : null;
                STATE.totalWeeks = STATE.schedule.length;
                STATE.leagueStats = data.gameState.leagueStats || { topScorers: [], topAssists: [], bestPlayers: [], awardsHistory: [] };
                STATE.userLineupSlots = data.gameState.userLineupSlots || Array(11).fill(null);
            } else {
                STATE.season = 1;
                STATE.history = [];
                STATE.newsFeed = [];
                STATE.userTeamId = null;
                STATE.leagueStats = { topScorers: [], topAssists: [], bestPlayers: [], awardsHistory: [] };
                STATE.userLineupSlots = Array(11).fill(null);
            }

            STATE.allTeams = data.clubs.map(club => ({
                id: String(club.id),
                name: club.name || "Unknown Club",
                leagueId: club.leagueId || club.leagueName || "GLOBAL",
                leagueName: club.leagueName || "Global League",
                stadiumName: club.stadiumName || "Municipal Stadium",
                teamRating: club.teamRating || 0,
                points: club.points || 0,
                played: club.played || 0,
                wins: club.wins || 0,
                draws: club.draws || 0,
                losses: club.losses || 0,
                gf: club.gf || 0,
                ga: club.ga || 0,
                gd: club.gd || 0,
                budget: club.budget || 50000000,
                color: club.color || generateColor(club.name || "Unknown"),
                squad: []
            }));

            data.players.forEach((player, index) => {
                const team = STATE.allTeams.find(t => t.id === String(player.clubId));
                if (team) {
                    player.internalId = index;
                    player.isStarter = player.isStarter || false;
                    player.transferListed = player.transferListed || false;
                    player.seasonGoals = player.seasonGoals || 0;
                    player.seasonAssists = player.seasonAssists || 0;
                    player.seasonRating = player.rating || 50;
                    player.age = player.age || Math.floor(Math.random() * 15) + 18;
                    player.careerGoals = player.careerGoals || 0;
                    player.injuryWeeks = player.injuryWeeks || 0;
                    player.isSuspended = player.isSuspended || false;
                    player.suspensionPending = player.suspensionPending || false;
                    player.speed = player.speed || 50;
                    player.shot = player.shot || 50;
                    player.pass = player.pass || 50;
                    player.dribble = player.dribble || 50;
                    player.clubId = String(player.clubId);
                    
                    if (player.potential === undefined) {
                        player.potential = player.rating + Math.floor(Math.random() * 10);
                    }

                    team.squad.push(player);
                }
            });

            if (data.gameState && STATE.userTeamId) {
                STATE.allTeams.forEach(team => {
                    if (team.id === STATE.userTeamId) {
                        updateTeamStartersFromSlots(team);
                    } else {
                        if (!team.squad.some(p => p.isStarter)) autoSelectStarters(team);
                    }
                    calculateTeamRating(team);
                });

                STATE.loaded = true;
                const userTeam = getTeam(STATE.userTeamId);
                if (userTeam) {
                    STATE.activeLeagueTeams = STATE.allTeams.filter(t => t.leagueId === userTeam.leagueId);
                }
                renderDashboard();
            } else {
                STATE.allTeams.forEach(team => {
                    if (team.id === STATE.userTeamId) {
                        updateTeamStartersFromSlots(team);
                    } else {
                        autoSelectStarters(team);
                    }
                    calculateTeamRating(team);
                });

                STATE.loaded = true;
                renderTeamSelection();
            }
        }

        function saveGame() {
            const saveData = {
                gameState: {
                    season: STATE.season,
                    history: STATE.history,
                    newsFeed: STATE.newsFeed,
                    currentWeek: STATE.currentWeek,
                    schedule: STATE.schedule,
                    userTeamId: STATE.userTeamId,
                    leagueStats: STATE.leagueStats,
                    userLineupSlots: STATE.userLineupSlots
                },
                clubs: STATE.allTeams.map(t => {
                    const { squad, ...rest } = t;
                    return rest;
                }),
                players: STATE.allTeams.flatMap(t => t.squad),
                leagues: Array.from(STATE.leaguesMap.entries()).map(([id, league]) => ({
                    id: id,
                    name: league.name,
                    division: league.division,
                    nation: league.nation,
                    promotions: league.promotions,
                    directPromotions: league.directPromotions,
                    relegations: league.relegations
                }))
            };
            const blob = new Blob([JSON.stringify(saveData, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `fm_save_season${STATE.season}_week${STATE.currentWeek}.json`;
            link.click();
            URL.revokeObjectURL(link.href);
        }

        function calculateTeamRating(team) {
            let totalRating = 0;
            let count = 0;
            
            if (team.id === STATE.userTeamId) {
                STATE.userLineupSlots.forEach(slotId => {
                    if (slotId !== null) {
                        const player = team.squad.find(p => p.internalId === slotId);
                        if (player) {
                            totalRating += player.rating;
                            count++;
                        }
                    }
                });
            } else {
                const starters = team.squad.filter(p => p.isStarter);
                starters.forEach(p => {
                    totalRating += p.rating;
                    count++;
                });
            }
            
            if (count > 0) {
                team.teamRating = Math.round(totalRating / count);
            } else {
                team.teamRating = 50;
            }
        }

        function calculateLeagueStats() {
            const allPlayers = [];
            
            STATE.activeLeagueTeams.forEach(team => {
                team.squad.forEach(player => {
                    allPlayers.push({
                        ...player,
                        teamName: team.name,
                        teamColor: team.color
                    });
                });
            });
            
            STATE.leagueStats.topScorers = [...allPlayers]
                .filter(p => p.seasonGoals > 0)
                .sort((a, b) => b.seasonGoals - a.seasonGoals || b.seasonRating - a.seasonRating)
                .slice(0, 10);
            
            STATE.leagueStats.topAssists = [...allPlayers]
                .filter(p => p.seasonAssists > 0)
                .sort((a, b) => b.seasonAssists - a.seasonAssists || b.seasonRating - a.seasonRating)
                .slice(0, 10);
            
            STATE.leagueStats.bestPlayers = [...allPlayers]
                .filter(p => {
                    const team = getTeam(p.clubId);
                    const matchesPlayed = team.played || 0;
                    return matchesPlayed >= 10;
                })
                .sort((a, b) => {
                    const aTotal = a.seasonRating + (a.seasonGoals * 0.5) + (a.seasonAssists * 0.3);
                    const bTotal = b.seasonRating + (b.seasonGoals * 0.5) + (b.seasonAssists * 0.3);
                    return bTotal - aTotal;
                })
                .slice(0, 10);
        }

        function updatePlayerPrice(player) {
            const basePrice = player.rating * 1000000;
            const newPrice = basePrice * (1 + PRICE_GROWTH_PER_RATING * (player.rating - 50) / 50);
            player.price = Math.round(newPrice / 100000) * 100000;
            player.price = Math.max(player.price, 100000);
        }

        function showPlayerStats() {
            calculateLeagueStats();
            
            const overlay = document.getElementById('player-stats-overlay');
            const content = document.getElementById('player-stats-content');
            
            content.innerHTML = `
                <div class="mb-6">
                    <h2 class="text-3xl font-black text-white mb-2">Season ${STATE.season} Statistics</h2>
                    <p class="text-slate-400">Top performers in ${STATE.activeLeagueTeams[0]?.leagueName || 'the league'}</p>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-slate-800/50 rounded-xl p-6 border border-slate-700">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center award-badge">
                                <span class="text-lg">⚽</span>
                            </div>
                            <h3 class="text-xl font-bold text-white">Golden Boot</h3>
                        </div>
                        <div class="space-y-3">
                            ${STATE.leagueStats.topScorers.length > 0 ? 
                                STATE.leagueStats.topScorers.map((player, index) => `
                                    <div class="flex items-center justify-between p-3 rounded-lg ${index === 0 ? 'bg-yellow-500/10 border border-yellow-500/30' : 'bg-slate-900/50 hover:bg-slate-900/80'}">
                                        <div class="flex items-center gap-3">
                                            <span class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${index === 0 ? 'award-badge' : 'bg-slate-700'}">
                                                ${index + 1}
                                            </span>
                                            <div>
                                                <div class="font-bold text-slate-200">${player.name}</div>
                                                <div class="text-xs text-slate-400">${player.teamName}</div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-xl font-black text-white">${player.seasonGoals}</div>
                                            <div class="text-xs text-slate-400">goals</div>
                                        </div>
                                    </div>
                                `).join('') :
                                '<div class="text-center text-slate-500 py-4">No goals scored yet</div>'
                            }
                        </div>
                    </div>
                    
                    <div class="bg-slate-800/50 rounded-xl p-6 border border-slate-700">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center award-badge">
                                <span class="text-lg">🎯</span>
                            </div>
                            <h3 class="text-xl font-bold text-white">Playmaker</h3>
                        </div>
                        <div class="space-y-3">
                            ${STATE.leagueStats.topAssists.length > 0 ? 
                                STATE.leagueStats.topAssists.map((player, index) => `
                                    <div class="flex items-center justify-between p-3 rounded-lg ${index === 0 ? 'bg-yellow-500/10 border border-yellow-500/30' : 'bg-slate-900/50 hover:bg-slate-900/80'}">
                                        <div class="flex items-center gap-3">
                                            <span class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${index === 0 ? 'award-badge' : 'bg-slate-700'}">
                                                ${index + 1}
                                            </span>
                                            <div>
                                                <div class="font-bold text-slate-200">${player.name}</div>
                                                <div class="text-xs text-slate-400">${player.teamName}</div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-xl font-black text-white">${player.seasonAssists}</div>
                                            <div class="text-xs text-slate-400">assists</div>
                                        </div>
                                    </div>
                                `).join('') :
                                '<div class="text-center text-slate-500 py-4">No assists yet</div>'
                            }
                        </div>
                    </div>
                    
                    <div class="bg-slate-800/50 rounded-xl p-6 border border-slate-700">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center award-badge">
                                <span class="text-lg">🏆</span>
                            </div>
                            <h3 class="text-xl font-bold text-white">Best Players</h3>
                        </div>
                        <div class="space-y-3">
                            ${STATE.leagueStats.bestPlayers.length > 0 ? 
                                STATE.leagueStats.bestPlayers.map((player, index) => `
                                    <div class="flex items-center justify-between p-3 rounded-lg ${index === 0 ? 'bg-yellow-500/10 border border-yellow-500/30' : 'bg-slate-900/50 hover:bg-slate-900/80'}">
                                        <div class="flex items-center gap-3">
                                            <span class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${index === 0 ? 'award-badge' : 'bg-slate-700'}">
                                                ${index + 1}
                                            </span>
                                            <div>
                                                <div class="font-bold text-slate-200">${player.name}</div>
                                                <div class="text-xs text-slate-400">${player.teamName} • ${player.pos}</div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-lg font-black text-white">${Math.round(player.seasonRating)}</div>
                                            <div class="text-xs text-slate-400">rating</div>
                                        </div>
                                    </div>
                                `).join('') :
                                '<div class="text-center text-slate-500 py-4">Not enough matches played</div>'
                            }
                        </div>
                    </div>
                </div>
                
                <div class="bg-slate-800/30 rounded-xl p-6 border border-slate-700">
                    <h3 class="text-xl font-bold text-white mb-4">Previous Awards</h3>
                    <div class="space-y-4">
                        ${STATE.leagueStats.awardsHistory.length > 0 ? 
                            STATE.leagueStats.awardsHistory.map(award => `
                                <div class="bg-slate-900/50 p-4 rounded-lg">
                                    <div class="text-lg font-bold text-slate-300 mb-2">Season ${award.season}</div>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                        <div class="flex items-center gap-2">
                                            <span class="text-yellow-400">⚽</span>
                                            <span class="text-slate-400">Golden Boot:</span>
                                            <span class="font-bold text-white">${award.goldenBoot?.player || 'N/A'}</span>
                                            <span class="text-slate-500">(${award.goldenBoot?.goals || 0})</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-yellow-400">🎯</span>
                                            <span class="text-slate-400">Playmaker:</span>
                                            <span class="font-bold text-white">${award.playmaker?.player || 'N/A'}</span>
                                            <span class="text-slate-500">(${award.playmaker?.assists || 0})</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-yellow-400">🏆</span>
                                            <span class="text-slate-400">Player of the Season:</span>
                                            <span class="font-bold text-white">${award.bestPlayer?.player || 'N/A'}</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('') :
                            '<div class="text-center text-slate-500 py-4">No previous awards</div>'
                        }
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end">
                    <button onclick="document.getElementById('player-stats-overlay').classList.add('hidden')" 
                            class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-6 rounded-lg">
                        Close
                    </button>
                </div>
            `;
            
            overlay.classList.remove('hidden');
        }

        function giveSeasonAwards() {
            calculateLeagueStats();
            
            const topScorer = STATE.leagueStats.topScorers[0];
            const topAssist = STATE.leagueStats.topAssists[0];
            const bestPlayer = STATE.leagueStats.bestPlayers[0];
            
            const seasonAward = {
                season: STATE.season,
                goldenBoot: topScorer ? {
                    player: topScorer.name,
                    team: getTeam(topScorer.clubId)?.name,
                    goals: topScorer.seasonGoals
                } : null,
                playmaker: topAssist ? {
                    player: topAssist.name,
                    team: getTeam(topAssist.clubId)?.name,
                    assists: topAssist.seasonAssists
                } : null,
                bestPlayer: bestPlayer ? {
                    player: bestPlayer.name,
                    team: getTeam(bestPlayer.clubId)?.name,
                    rating: Math.round(bestPlayer.seasonRating)
                } : null
            };
            
            STATE.leagueStats.awardsHistory.unshift(seasonAward);
            if (STATE.leagueStats.awardsHistory.length > 10) {
                STATE.leagueStats.awardsHistory.pop();
            }
            
            if (topScorer && topScorer.seasonGoals > 0) {
                addNews(
                    'Season Awards',
                    `${topScorer.name} wins the Golden Boot with ${topScorer.seasonGoals} goals!`,
                    'award'
                );
            }
            
            if (topAssist && topAssist.seasonAssists > 0) {
                addNews(
                    'Season Awards',
                    `${topAssist.name} wins the Playmaker award with ${topAssist.seasonAssists} assists!`,
                    'award'
                );
            }
            
            if (bestPlayer) {
                addNews(
                    'Season Awards',
                    `${bestPlayer.name} is the Player of the Season with a ${Math.round(bestPlayer.seasonRating)} rating!`,
                    'award'
                );
            }
            
            if (topScorer) {
                const team = getTeam(topScorer.clubId);
                if (team) {
                    const bonus = 1000000 * Math.max(1, Math.floor(topScorer.seasonGoals / 5));
                    team.budget += bonus;
                    addNews(
                        'Player Bonus',
                        `${topScorer.name} receives ${formatMoney(bonus)} bonus for winning the Golden Boot!`,
                        'info'
                    );
                }
            }
            
            if (topAssist) {
                const team = getTeam(topAssist.clubId);
                if (team) {
                    const bonus = 500000 * Math.max(1, Math.floor(topAssist.seasonAssists / 3));
                    team.budget += bonus;
                    addNews(
                        'Player Bonus',
                        `${topAssist.name} receives ${formatMoney(bonus)} bonus for winning the Playmaker award!`,
                        'info'
                    );
                }
            }
            
            if (bestPlayer) {
                const team = getTeam(bestPlayer.clubId);
                if (team) {
                    const bonus = 2000000;
                    team.budget += bonus;
                    addNews(
                        'Player Bonus',
                        `${bestPlayer.name} receives ${formatMoney(bonus)} bonus for being Player of the Season!`,
                        'info'
                    );
                }
            }
        }

        function initSchedule() {
            const teamIds = STATE.activeLeagueTeams.map(t => t.id);
            if (teamIds.length < 2) return;
            STATE.schedule = generateFixtures(teamIds);
            STATE.totalWeeks = STATE.schedule.length;
            STATE.currentWeek = 0;
        }

        function generateFixtures(teamIds) {
            const fixtures = [];
            const teams = [...teamIds]; 
            if (teams.length % 2 !== 0) teams.push(null);
            
            const half = teams.length / 2;
            const home = teams.slice(0, half);
            const away = teams.slice(half).reverse();

            for (let round = 0; round < teams.length - 1; round++) {
                const weekMatches = [];
                for (let i = 0; i < home.length; i++) {
                    if (home[i] !== null && away[i] !== null) {
                        weekMatches.push({ home: home[i], away: away[i] });
                    }
                }
                fixtures.push(weekMatches);
                const lastHome = home.pop();
                const firstAway = away.shift();
                home.splice(1, 0, firstAway);
                away.push(lastHome);
            }
            
            const secondHalf = fixtures.map(week => week.map(m => ({ home: m.away, away: m.home })));
            return [...fixtures, ...secondHalf];
        }

        function getTeam(id) { 
            if (!id) return null;
            const idStr = String(id);
            return STATE.allTeams.find(t => t.id === idStr); 
        }

        function processPromotionRelegation() {
            console.log("Processing promotion/relegation...");
            
            const userTeam = getTeam(STATE.userTeamId);
            const oldLeagueId = userTeam.leagueId;
            const oldLeagueInfo = STATE.leaguesMap.get(oldLeagueId) || { 
                name: userTeam.leagueName, 
                division: 1,
                promotions: 3,
                directPromotions: 3,
                relegations: 3
            };
            
            const leaguesByNation = {};
            
            STATE.leaguesMap.forEach((league, leagueId) => {
                if (!leaguesByNation[league.nation]) {
                    leaguesByNation[league.nation] = [];
                }
                leaguesByNation[league.nation].push({
                    id: leagueId,
                    ...league
                });
            });
            
            const promotedTeams = [];
            const relegatedTeams = [];
            
            for (const nation in leaguesByNation) {
                const leagues = leaguesByNation[nation];
                leagues.sort((a, b) => a.division - b.division);
                
                for (let i = 0; i < leagues.length - 1; i++) {
                    const upperLeague = leagues[i];
                    const lowerLeague = leagues[i + 1];
                    
                    const upperTeams = STATE.allTeams.filter(t => t.leagueId === upperLeague.id);
                    const lowerTeams = STATE.allTeams.filter(t => t.leagueId === lowerLeague.id);
                    
                    if (upperTeams.length === 0 || lowerTeams.length === 0) continue;
                    
                    const sortedUpperTeams = [...upperTeams].sort((a, b) => 
                        b.points - a.points || b.gd - a.gd || b.gf - a.gf
                    );
                    
                    const sortedLowerTeams = [...lowerTeams].sort((a, b) => 
                        b.points - a.points || b.gd - a.gd || b.gf - a.gf
                    );
                    
                    const relegationSpots = upperLeague.relegations || 3;
                    const promotionSpots = lowerLeague.promotions || 3;
                    const directPromotionSpots = lowerLeague.directPromotions || promotionSpots;
                    
                    const relegated = sortedUpperTeams.slice(-relegationSpots);
                    const promoted = sortedLowerTeams.slice(0, promotionSpots);
                    
                    relegated.forEach(team => {
                        console.log(`${team.name} relegated from ${upperLeague.name} to ${lowerLeague.name}`);
                        team.leagueId = lowerLeague.id;
                        team.leagueName = lowerLeague.name;
                        relegatedTeams.push({
                            team: team.name,
                            from: upperLeague.name,
                            to: lowerLeague.name,
                            divisionFrom: upperLeague.division,
                            divisionTo: lowerLeague.division
                        });
                    });
                    
                    promoted.forEach(team => {
                        console.log(`${team.name} promoted from ${lowerLeague.name} to ${upperLeague.name}`);
                        team.leagueId = upperLeague.id;
                        team.leagueName = upperLeague.name;
                        promotedTeams.push({
                            team: team.name,
                            from: lowerLeague.name,
                            to: upperLeague.name,
                            divisionFrom: lowerLeague.division,
                            divisionTo: upperLeague.division
                        });
                    });
                }
            }
            
            let userStatus = 'REMAIN';
            let userNewLeague = null;
            let userDivisionChange = null;
            
            const userPromoted = promotedTeams.find(p => p.team === userTeam.name);
            if (userPromoted) {
                userStatus = 'PROMOTED';
                userNewLeague = userPromoted.to;
                userDivisionChange = { from: userPromoted.divisionFrom, to: userPromoted.divisionTo };
                
                addNews(
                    'Promotion!',
                    `${userTeam.name} promoted from ${userPromoted.from} to ${userPromoted.to}!`,
                    'info'
                );
            }
            
            const userRelegated = relegatedTeams.find(r => r.team === userTeam.name);
            if (userRelegated) {
                userStatus = 'RELEGATED';
                userNewLeague = userRelegated.to;
                userDivisionChange = { from: userRelegated.divisionFrom, to: userRelegated.divisionTo };
                
                addNews(
                    'Relegation',
                    `${userTeam.name} relegated from ${userRelegated.from} to ${userRelegated.to}.`,
                    'info'
                );
            }
            
            if (userStatus === 'REMAIN') {
                userNewLeague = oldLeagueInfo.name;
                userDivisionChange = { from: oldLeagueInfo.division, to: oldLeagueInfo.division };
            }
            
            const otherPromoted = promotedTeams.filter(p => p.team !== userTeam.name);
            const otherRelegated = relegatedTeams.filter(r => r.team !== userTeam.name);
            
            if (otherPromoted.length > 0) {
                addNews(
                    'Promotions',
                    `${otherPromoted.length} team(s) promoted: ${otherPromoted.map(p => p.team).join(', ')}`,
                    'info'
                );
            }
            
            if (otherRelegated.length > 0) {
                addNews(
                    'Relegations',
                    `${otherRelegated.length} team(s) relegated: ${otherRelegated.map(r => r.team).join(', ')}`,
                    'info'
                );
            }
            
            updateLeagueGroups();
            
            return { 
                userStatus, 
                userNewLeague, 
                userDivisionChange,
                promotedTeams, 
                relegatedTeams 
            };
        }

        function updateLeagueGroups() {
            const userTeam = getTeam(STATE.userTeamId);
            if (userTeam) {
                STATE.activeLeagueTeams = STATE.allTeams.filter(t => t.leagueId === userTeam.leagueId);
            }
            
            STATE.allTeams.forEach(team => {
                team.points = 0;
                team.played = 0;
                team.wins = 0;
                team.draws = 0;
                team.losses = 0;
                team.gf = 0;
                team.ga = 0;
                team.gd = 0;
            });
            
            if (STATE.activeLeagueTeams.length >= 2) {
                initSchedule();
            }
        }

        function simulateMatch(homeId, awayId) {
            const home = getTeam(homeId);
            const away = getTeam(awayId);

            if (home.id !== STATE.userTeamId) {
                if (home.squad.some(p => p.isStarter && (p.injuryWeeks > 0 || p.isSuspended))) {
                    autoSelectStarters(home);
                }
            }
            if (away.id !== STATE.userTeamId) {
                if (away.squad.some(p => p.isStarter && (p.injuryWeeks > 0 || p.isSuspended))) {
                    autoSelectStarters(away);
                }
            }

            calculateTeamRating(home);
            calculateTeamRating(away);

            STATE.matchRedCards.clear();
            STATE.matchRedCards.set(homeId, { count: 0, minute: null });
            STATE.matchRedCards.set(awayId, { count: 0, minute: null });

            const ratingDiff = home.teamRating - away.teamRating;
            const homeAdvantage = 5;

            let lambdaHome = Math.max(0.1, 1.3 + (ratingDiff + homeAdvantage) * 0.035);
            let lambdaAway = Math.max(0.1, 1.0 - (ratingDiff) * 0.035);

            const scoreHome = Math.floor(Math.random() * 3 * lambdaHome + (Math.random() > 0.65 ? 1 : 0));
            const scoreAway = Math.floor(Math.random() * 3 * lambdaAway + (Math.random() > 0.80 ? 1 : 0));

            let possHome = 50 + (ratingDiff + homeAdvantage) * 0.6;
            possHome = Math.floor(Math.max(30, Math.min(70, possHome + (Math.random() * 10 - 5))));
            const possAway = 100 - possHome;

            const shotsHome = Math.floor(scoreHome * 2 + (home.teamRating/10) + Math.random() * 5);
            const shotsAway = Math.floor(scoreAway * 2 + (away.teamRating/10) + Math.random() * 5);

            const matchEvents = [];
            const scorersHome = processGoals(home, scoreHome, matchEvents);
            const scorersAway = processGoals(away, scoreAway, matchEvents);

            processIncidents(home, matchEvents);
            processIncidents(away, matchEvents);

            const homeRedCards = STATE.matchRedCards.get(homeId)?.count || 0;
            const awayRedCards = STATE.matchRedCards.get(awayId)?.count || 0;

            let adjustedScoreHome = scoreHome;
            let adjustedScoreAway = scoreAway;
            let adjustedShotsHome = shotsHome;
            let adjustedShotsAway = shotsAway;
            let adjustedPossHome = possHome;
            let adjustedPossAway = possAway;

            if (homeRedCards > 0) {
                const penalty = Math.pow(RED_CARD_TEAM_PENALTY, homeRedCards);
                adjustedScoreHome = Math.floor(adjustedScoreHome * penalty);
                adjustedShotsHome = Math.floor(adjustedShotsHome * penalty);
                adjustedPossHome = Math.floor(adjustedPossHome * penalty);
                
                const boost = Math.pow(RED_CARD_OPPONENT_BOOST, homeRedCards);
                adjustedScoreAway = Math.floor(adjustedScoreAway * boost);
                adjustedShotsAway = Math.floor(adjustedShotsAway * boost);
                adjustedPossAway = 100 - adjustedPossHome;
            }

            if (awayRedCards > 0) {
                const penalty = Math.pow(RED_CARD_TEAM_PENALTY, awayRedCards);
                adjustedScoreAway = Math.floor(adjustedScoreAway * penalty);
                adjustedShotsAway = Math.floor(adjustedShotsAway * penalty);
                adjustedPossAway = Math.floor(adjustedPossAway * penalty);
                
                const boost = Math.pow(RED_CARD_OPPONENT_BOOST, awayRedCards);
                adjustedScoreHome = Math.floor(adjustedScoreHome * boost);
                adjustedShotsHome = Math.floor(adjustedShotsHome * boost);
                adjustedPossHome = 100 - adjustedPossAway;
            }

            adjustedScoreHome = Math.max(0, adjustedScoreHome);
            adjustedScoreAway = Math.max(0, adjustedScoreAway);
            adjustedShotsHome = Math.max(0, adjustedShotsHome);
            adjustedShotsAway = Math.max(0, adjustedShotsAway);
            adjustedPossHome = Math.max(20, Math.min(80, adjustedPossHome));
            adjustedPossAway = 100 - adjustedPossHome;

            if (home.id === STATE.userTeamId || away.id === STATE.userTeamId) {
                matchEvents.push(...generateCommentary(home, away, adjustedScoreHome, adjustedScoreAway, scorersHome, scorersAway, homeRedCards, awayRedCards));
            }

            updatePlayerRatings(home, away, adjustedScoreHome, adjustedScoreAway);

            const matchResult = { 
                homeId, awayId, 
                homeGoals: adjustedScoreHome, 
                awayGoals: adjustedScoreAway,
                stats: { 
                    possHome: adjustedPossHome, 
                    possAway: adjustedPossAway, 
                    shotsHome: adjustedShotsHome, 
                    shotsAway: adjustedShotsAway, 
                    scorersHome, 
                    scorersAway,
                    redCardsHome: homeRedCards,
                    redCardsAway: awayRedCards
                },
                events: matchEvents.sort(() => Math.random() - 0.5) 
            };

            STATE.matchRedCards.clear();

            return matchResult;
        }

        function processIncidents(team, events) {
            const starters = team.squad.filter(p => p.isStarter);
            starters.forEach(p => {
                if (Math.random() < INJURY_CHANCE) {
                    p.injuryWeeks = Math.floor(Math.random() * 5) + 1;
                    events.push(`INJURY: ${p.name} (${team.name}) limps off! Out for ${p.injuryWeeks} weeks.`);
                    if (team.id === STATE.userTeamId) {
                        addNews('Medical Report', `${p.name} injured for ${p.injuryWeeks} weeks`, 'injury');
                    }
                }
                else if (Math.random() < 0.005) {
                    p.suspensionPending = true;
                    const redCardData = STATE.matchRedCards.get(team.id) || { count: 0, minute: Math.floor(Math.random() * 90) };
                    redCardData.count++;
                    redCardData.minute = redCardData.minute || Math.floor(Math.random() * 90);
                    STATE.matchRedCards.set(team.id, redCardData);
                    
                    events.push(`RED CARD! ${p.name} (${team.name}) is sent off in minute ${redCardData.minute}! Team down to ${10 - redCardData.count} players.`);
                    if (team.id === STATE.userTeamId) {
                        addNews('Disciplinary', `${p.name} received a Red Card. Suspended for 1 match.`, 'injury');
                    }
                }
            });
        }

        function generateCommentary(home, away, sHome, sAway, scHome, scAway, homeRedCards, awayRedCards) {
            const lines = [];
            lines.push(`KICK OFF at ${home.stadiumName}!`);
            
            if (homeRedCards > 0) {
                lines.push(`${home.name} playing with ${11 - homeRedCards} men due to red card(s)!`);
            }
            if (awayRedCards > 0) {
                lines.push(`${away.name} playing with ${11 - awayRedCards} men due to red card(s)!`);
            }
            
            scHome.forEach(p => {
                if (!p.isAssist) lines.push(`GOAL! ${p.name} scores for ${home.name}!`);
            });
            scAway.forEach(p => {
                if (!p.isAssist) lines.push(`GOAL! ${p.name} scores for ${away.name}!`);
            });
            const keepers = [...home.squad.filter(p=>p.isStarter && getPosCategory(p.pos)==1), ...away.squad.filter(p=>p.isStarter && getPosCategory(p.pos)==1)];
            if(keepers.length > 0) lines.push(`Great save by ${keepers[Math.floor(Math.random()*keepers.length)].name}!`);
            lines.push("End to end stuff here!");
            lines.push("The manager is shouting instructions from the touchline.");
            
            if (homeRedCards > 0 && sHome < sAway) {
                lines.push(`${home.name} struggling with a man down!`);
            }
            if (awayRedCards > 0 && sAway < sHome) {
                lines.push(`${away.name} struggling with a man down!`);
            }
            
            return lines;
        }

        function processGoals(team, goalCount, events) {
            const scorers = [];
            const starters = team.squad.filter(p => p.isStarter);
            if (starters.length === 0) return scorers;

            for (let i = 0; i < goalCount; i++) {
                const weightedPool = [];
                starters.forEach(p => {
                    const weight = POS_SCORING_WEIGHT[getPosCategory(p.pos)] || 1;
                    for(let k=0; k<weight; k++) weightedPool.push(p);
                });

                if (weightedPool.length > 0) {
                    const scorer = weightedPool[Math.floor(Math.random() * weightedPool.length)];
                    scorer.seasonGoals++;
                    scorer.careerGoals++;
                    scorers.push(scorer);

                    if (Math.random() > 0.3) {
                        const teammates = starters.filter(p => p !== scorer);
                        if (teammates.length > 0) {
                            const assister = teammates[Math.floor(Math.random() * teammates.length)];
                            assister.seasonAssists++;
                            scorers.push({...assister, isAssist: true});
                        }
                    }
                }
            }
            return scorers;
        }

        function updatePlayerRatings(home, away, homeGoals, awayGoals) {
            const starters = [...home.squad.filter(p => p.isStarter), ...away.squad.filter(p => p.isStarter)];
            starters.forEach(p => {
                const baseChange = Math.random() * 0.5 - 0.25;
                const matchRating = p.seasonRating + baseChange;
                p.seasonRating = Math.max(30, Math.min(99, matchRating));
            });
        }

        function validateStartingXI(team) {
            const emptySlots = STATE.userLineupSlots.filter(slot => slot === null);
            
            if (emptySlots.length > 0) {
                const slotPositions = getSlotPositions();
                const emptyPositions = [];
                
                slotPositions.forEach((pos, index) => {
                    if (STATE.userLineupSlots[index] === null) {
                        const posName = pos.position === 'GK' ? 'Goalkeeper' :
                                      pos.position === 'DEF' ? 'Defender' :
                                      pos.position === 'MID' ? 'Midfielder' : 'Forward';
                        if (!emptyPositions.includes(posName)) {
                            emptyPositions.push(posName);
                        }
                    }
                });
                
                return {
                    valid: false,
                    message: `Starting XI not complete! Missing: ${emptyPositions.join(', ')} (${emptySlots.length} empty slot${emptySlots.length > 1 ? 's' : ''})`
                };
            }
            
            const unavailableStarters = [];
            STATE.userLineupSlots.forEach(slotId => {
                if (slotId !== null) {
                    const player = team.squad.find(p => p.internalId === slotId);
                    if (player && (player.injuryWeeks > 0 || player.isSuspended)) {
                        unavailableStarters.push(player.name);
                    }
                }
            });
            
            if (unavailableStarters.length > 0) {
                const names = unavailableStarters.join(', ');
                return {
                    valid: false,
                    message: `Cannot play with unavailable players in Starting XI: ${names}`
                };
            }
            
            return { valid: true, message: "Starting XI is ready!" };
        }

        function openSlotSelection(slotIndex) {
            const userTeam = getTeam(STATE.userTeamId);
            if (!userTeam) return;
            
            STATE.slotSelection = slotIndex;
            
            const slotPositions = getSlotPositions();
            const slotPosition = slotPositions[slotIndex];
            
            const availablePlayers = userTeam.squad.filter(player => {
                const isInLineup = STATE.userLineupSlots.includes(player.internalId);
                if (isInLineup) return false;
                
                const playerCategory = getPosCategory(player.pos);
                const slotCategory = getPosCategory(slotPosition.position);
                
                return playerCategory === slotCategory;
            });
            
            availablePlayers.sort((a, b) => b.rating - a.rating);
            
            const overlay = document.getElementById('slot-select-overlay');
            const title = document.getElementById('slot-select-title');
            const subtitle = document.getElementById('slot-select-subtitle');
            const playersContainer = document.getElementById('slot-select-players');
            const countElement = document.getElementById('slot-select-count');
            
            const positionName = slotPosition.position === 'GK' ? 'Goalkeeper' :
                               slotPosition.position === 'DEF' ? 'Defender' :
                               slotPosition.position === 'MID' ? 'Midfielder' : 'Forward';
            
            title.textContent = `Select ${positionName}`;
            subtitle.textContent = `Choose a player for ${positionName} slot #${slotPosition.index + 1}:`;
            
            if (availablePlayers.length === 0) {
                playersContainer.innerHTML = `
                    <div class="text-center text-slate-500 py-8">
                        <div class="text-4xl mb-2">😕</div>
                        <p>No available ${positionName.toLowerCase()} players on the bench</p>
                        <p class="text-sm mt-2">You may need to sign new players or move players between positions</p>
                    </div>
                `;
            } else {
                playersContainer.innerHTML = availablePlayers.map(player => `
                    <div class="flex items-center justify-between p-3 rounded-lg bg-slate-700/30 hover:bg-slate-700/50 cursor-pointer transition-colors"
                         onclick="selectPlayerForSlot(${player.internalId})">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center bg-slate-800 text-sm font-bold">
                                ${player.rating}
                            </div>
                            <div>
                                <div class="font-bold text-slate-200">${player.name}</div>
                                <div class="text-xs text-slate-400">${player.pos} • Age: ${player.age}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-mono text-emerald-400">${formatMoney(player.price)}</div>
                            <div class="text-xs text-slate-400">Rating: ${player.rating}</div>
                        </div>
                    </div>
                `).join('');
            }
            
            countElement.textContent = `${availablePlayers.length} player${availablePlayers.length !== 1 ? 's' : ''} available`;
            overlay.classList.remove('hidden');
        }

        function selectPlayerForSlot(playerId) {
            if (STATE.slotSelection === null) return;
            
            const userTeam = getTeam(STATE.userTeamId);
            const player = userTeam.squad.find(p => p.internalId === playerId);
            
            if (!player) return;
            
            if (player.injuryWeeks > 0 || player.isSuspended) {
                alert(`Cannot select ${player.name} - ${player.injuryWeeks > 0 ? 'Injured' : 'Suspended'}!`);
                return;
            }
            
            setPlayerInSlot(STATE.slotSelection, playerId);
            
            document.getElementById('slot-select-overlay').classList.add('hidden');
            STATE.slotSelection = null;
            renderDashboard();
        }

        async function playWeek() {
            const userTeam = getTeam(STATE.userTeamId);
            
            const validation = validateStartingXI(userTeam);
            if (!validation.valid) {
                alert(validation.message);
                return;
            }
            
            if (STATE.currentWeek >= STATE.schedule.length) {
                endSeason();
                return;
            }

            const weekMatches = STATE.schedule[STATE.currentWeek];
            const results = [];

            weekMatches.forEach(match => {
                const res = simulateMatch(match.home, match.away);
                results.push(res);
                
                const home = getTeam(res.homeId);
                const away = getTeam(res.awayId);

                home.gf += res.homeGoals; 
                home.ga += res.awayGoals; 
                home.gd = home.gf - home.ga; 
                home.played++;
                
                away.gf += res.awayGoals; 
                away.ga += res.homeGoals; 
                away.gd = away.gf - away.ga; 
                away.played++;

                if (res.homeGoals > res.awayGoals) { 
                    home.points += 3; 
                    home.wins++; 
                    away.losses++; 
                }
                else if (res.homeGoals < res.awayGoals) { 
                    away.points += 3; 
                    away.wins++; 
                    home.losses++; 
                }
                else { 
                    home.points += 1; 
                    away.points += 1; 
                    home.draws++; 
                    away.draws++; 
                }
            });

            const userMatch = results.find(r => r.homeId === STATE.userTeamId || r.awayId === STATE.userTeamId);
            if (userMatch) {
                await renderLiveMatch(userMatch);
            }

            updateRecovery();
            
            const offer = await processTransferMarket();
            
            STATE.currentWeek++;
            renderDashboard();

            if (STATE.currentWeek >= STATE.totalWeeks) {
                if (offer) {
                    showOfferModal(offer, () => {
                         showResultsModal(results, () => endSeason());
                    });
                } else {
                    showResultsModal(results, () => endSeason());
                }
            } else {
                if (offer) {
                    showOfferModal(offer, () => showResultsModal(results));
                } else {
                    showResultsModal(results);
                }
            }
        }

        function endSeason() {
            giveSeasonAwards();
            
            const promotionRelegationResult = processPromotionRelegation();
            showPromotionRelegationNotification(promotionRelegationResult);
            showSeasonEndSummary(promotionRelegationResult);
        }

        function showPromotionRelegationNotification(prResult) {
            const { userStatus, userNewLeague, userDivisionChange } = prResult;
            
            if (userStatus === 'REMAIN') {
                return;
            }
            
            const overlay = document.getElementById('promo-relegation-overlay');
            const title = document.getElementById('pr-title');
            const message = document.getElementById('pr-message');
            const details = document.getElementById('pr-details');
            const btnContinue = document.getElementById('btn-pr-continue');
            
            const userTeam = getTeam(STATE.userTeamId);
            
            if (userStatus === 'PROMOTED') {
                title.textContent = 'PROMOTION!';
                title.className = 'text-emerald-400 font-black text-xl mb-4 uppercase tracking-widest border-b border-slate-700 pb-2';
                
                message.innerHTML = `
                    <div class="text-lg font-bold text-emerald-300 mb-2">Congratulations!</div>
                    <div class="text-slate-300">Your team has been promoted to a higher division.</div>
                `;
                
                details.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-slate-400">From:</span>
                        <span class="text-slate-300">${userTeam.leagueName} (Div ${userDivisionChange.from})</span>
                    </div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-slate-400">To:</span>
                        <span class="text-emerald-300 font-bold">${userNewLeague} (Div ${userDivisionChange.to})</span>
                    </div>
                    <div class="h-px bg-slate-700 my-3"></div>
                    <div class="text-center text-xs text-slate-500">
                        Your team will compete in the new division next season
                    </div>
                `;
                
                message.innerHTML += `<div class="text-4xl mt-4">🎉🏆</div>`;
            }
            else if (userStatus === 'RELEGATED') {
                title.textContent = 'RELEGATION';
                title.className = 'text-red-400 font-black text-xl mb-4 uppercase tracking-widest border-b border-slate-700 pb-2';
                
                message.innerHTML = `
                    <div class="text-lg font-bold text-red-300 mb-2">Bad luck...</div>
                    <div class="text-slate-300">Your team has been relegated to a lower division.</div>
                `;
                
                details.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-slate-400">From:</span>
                        <span class="text-slate-300">${userTeam.leagueName} (Div ${userDivisionChange.from})</span>
                    </div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-slate-400">To:</span>
                        <span class="text-red-300 font-bold">${userNewLeague} (Div ${userDivisionChange.to})</span>
                    </div>
                    <div class="h-px bg-slate-700 my-3"></div>
                    <div class="text-center text-xs text-slate-500">
                        Your team will compete in the new division next season
                    </div>
                `;
                
                message.innerHTML += `<div class="text-4xl mt-4">💪📉</div>`;
            }
            
            btnContinue.onclick = () => {
                overlay.classList.add('hidden');
            };
            
            overlay.classList.remove('hidden');
        }

        function showSeasonEndSummary(prResult) {
            const overlay = document.getElementById('season-end-overlay');
            const content = document.getElementById('season-end-content');
            
            const sorted = [...STATE.activeLeagueTeams].sort((a, b) => b.points - a.points || b.gd - a.gd || b.gf - a.gf);
            const winner = sorted[0];
            const isUserWinner = winner.id === STATE.userTeamId;

            if (isUserWinner) {
                STATE.history.push({ year: STATE.season, title: `${winner.leagueName} Champion` });
                createConfetti();
            }

            addNews('Season Update', `Season ${STATE.season} has ended. Champion: ${winner.name}`, 'info');

            calculateLeagueStats();
            const topScorer = STATE.leagueStats.topScorers[0];
            const topAssist = STATE.leagueStats.topAssists[0];
            const bestPlayer = STATE.leagueStats.bestPlayers[0];

            content.innerHTML = `
                <div class="glass-panel p-10 rounded-2xl border ${isUserWinner ? 'border-yellow-400' : 'border-slate-700'} shadow-2xl relative overflow-hidden">
                    ${isUserWinner ? '<div class="absolute inset-0 bg-yellow-400/10 animate-pulse"></div>' : ''}
                    
                    <h1 class="text-5xl font-black mb-4 text-white uppercase tracking-widest relative z-10">Season ${STATE.season} Finished</h1>
                    <div class="text-2xl font-bold mb-8 relative z-10">
                        Champion: <span class="${isUserWinner ? 'text-yellow-400' : 'text-white'}">${winner.name}</span>
                    </div>

                    <div class="mb-8 relative z-10">
                        ${isUserWinner 
                            ? `<div class="text-6xl mb-4">🏆</div><p class="text-yellow-400 font-bold text-xl">CONGRATULATIONS MANAGER!</p>` 
                            : `<div class="text-6xl mb-4">🏁</div><p class="text-slate-400">Better luck next season!</p>`}
                    </div>
                    
                    <div class="mb-8 bg-slate-900/50 rounded-xl p-6 border border-slate-700 relative z-10">
                        <h3 class="text-xl font-bold text-white mb-4 text-center">Season Awards</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="text-center">
                                <div class="text-4xl mb-2">⚽</div>
                                <div class="font-bold text-slate-300">Golden Boot</div>
                                ${topScorer ? `
                                    <div class="text-white font-bold mt-1">${topScorer.name}</div>
                                    <div class="text-yellow-400 text-2xl font-black">${topScorer.seasonGoals}</div>
                                    <div class="text-slate-400 text-sm">${getTeam(topScorer.clubId)?.name}</div>
                                ` : '<div class="text-slate-500 mt-2">No top scorer</div>'}
                            </div>
                            
                            <div class="text-center">
                                <div class="text-4xl mb-2">🎯</div>
                                <div class="font-bold text-slate-300">Playmaker</div>
                                ${topAssist ? `
                                    <div class="text-white font-bold mt-1">${topAssist.name}</div>
                                    <div class="text-yellow-400 text-2xl font-black">${topAssist.seasonAssists}</div>
                                    <div class="text-slate-400 text-sm">${getTeam(topAssist.clubId)?.name}</div>
                                ` : '<div class="text-slate-500 mt-2">No top assister</div>'}
                            </div>
                            
                            <div class="text-center">
                                <div class="text-4xl mb-2">🏆</div>
                                <div class="font-bold text-slate-300">Player of the Season</div>
                                ${bestPlayer ? `
                                    <div class="text-white font-bold mt-1">${bestPlayer.name}</div>
                                    <div class="text-yellow-400 text-2xl font-black">${Math.round(bestPlayer.seasonRating)}</div>
                                    <div class="text-slate-400 text-sm">${getTeam(bestPlayer.clubId)?.name}</div>
                                ` : '<div class="text-slate-500 mt-2">No player of the season</div>'}
                            </div>
                        </div>
                        
                        <div class="mt-6 text-center">
                            <button onclick="showPlayerStats()" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-6 rounded-lg">
                                View Full Statistics
                            </button>
                        </div>
                    </div>

                    <button onclick="startNextSeason()" class="mt-8 bg-[#4caf50] hover:bg-[#43a047] text-white font-bold py-4 px-10 rounded-xl uppercase tracking-wider text-lg shadow-xl shadow-green-900/30 relative z-10 transform transition hover:scale-105">
                        Start Season ${STATE.season + 1}
                    </button>
                </div>
            `;
            
            overlay.classList.remove('hidden');
        }

        function createConfetti() {
            for (let i = 0; i < 100; i++) {
                const conf = document.createElement('div');
                conf.className = 'confetti';
                conf.style.left = Math.random() * 100 + 'vw';
                conf.style.backgroundColor = ['#ff0', '#f00', '#0f0', '#00f', '#f0f'][Math.floor(Math.random() * 5)];
                conf.style.animationDuration = (Math.random() * 3 + 2) + 's';
                document.body.appendChild(conf);
                setTimeout(() => conf.remove(), 5000);
            }
        }

        function startNextSeason() {
            document.getElementById('season-end-overlay').classList.add('hidden');
            STATE.season++;
            STATE.currentWeek = 0;

            const sorted = [...STATE.activeLeagueTeams].sort((a, b) => b.points - a.points);
            
            STATE.allTeams.forEach(team => {
                const rank = sorted.findIndex(t => t.id === team.id);
                if (rank !== -1) {
                    const prize = Math.max(5000000, 50000000 - (rank * 2000000));
                    team.budget += prize;
                }
                
                team.points = 0; team.played = 0; team.wins = 0; 
                team.draws = 0; team.losses = 0; team.gf = 0; 
                team.ga = 0; team.gd = 0;

                team.squad.forEach((p, idx) => {
                    p.careerGoals += p.seasonGoals;
                    p.seasonGoals = 0;
                    p.seasonAssists = 0;
                    p.seasonRating = p.rating;
                    p.age++;

                    updatePlayerPrice(p);
                });
                
                if (team.id === STATE.userTeamId) {
                    updateTeamStartersFromSlots(team);
                } else {
                    autoSelectStarters(team);
                }
                calculateTeamRating(team);
            });

            initSchedule();
            saveGame();
            renderDashboard();
        }

        function updateRecovery() {
            STATE.allTeams.forEach(t => {
                t.squad.forEach(p => {
                    if (p.injuryWeeks > 0) p.injuryWeeks--;
                    if (p.isSuspended) p.isSuspended = false; 
                    if (p.suspensionPending) {
                        p.isSuspended = true; 
                        p.suspensionPending = false;
                    }
                });
            });
        }

        function renderLiveMatch(match) {
            return new Promise(resolve => {
                const modal = document.getElementById('live-match-overlay');
                const feed = document.getElementById('live-feed');
                const btn = document.getElementById('btn-live-continue');
                const timer = document.getElementById('live-timer');
                const hName = document.getElementById('live-home-name');
                const aName = document.getElementById('live-away-name');
                const hScore = document.getElementById('live-score-home');
                const aScore = document.getElementById('live-score-away');
                const stadium = document.getElementById('live-stadium');

                const home = getTeam(match.homeId);
                const away = getTeam(match.awayId);

                hName.textContent = home.name;
                aName.textContent = away.name;
                stadium.textContent = "Live from " + home.stadiumName;
                hScore.textContent = '0';
                aScore.textContent = '0';
                feed.innerHTML = '';
                btn.classList.add('hidden');
                modal.classList.remove('hidden');

                const events = [...match.events];
                let step = 0;
                
                let currentHomeGoals = 0;
                let currentAwayGoals = 0;
                
                const goalEvents = [];
                const otherEvents = [];
                
                events.forEach(event => {
                    if (event.includes('GOAL!')) {
                        goalEvents.push(event);
                    } else {
                        otherEvents.push(event);
                    }
                });
                
                const allEvents = [...goalEvents, ...otherEvents].sort(() => Math.random() - 0.5);
                
                const interval = setInterval(() => {
                    step++;
                    const currentMinute = Math.min(90, Math.floor((step / (allEvents.length + 10)) * 90));
                    timer.textContent = currentMinute + "'";

                    if (allEvents.length > 0 && Math.random() > 0.4) {
                        const event = allEvents.shift();
                        const line = document.createElement('div');
                        line.className = 'ticker-line text-slate-300 border-l-2 border-[#4caf50] pl-2';
                        line.textContent = event;
                        feed.prepend(line);
                        
                        if (event.includes('GOAL!')) {
                            if (event.includes(home.name)) {
                                currentHomeGoals++;
                                hScore.textContent = currentHomeGoals;
                                hScore.classList.add('score-pulse');
                                setTimeout(() => hScore.classList.remove('score-pulse'), 500);
                                line.className = 'ticker-line font-bold text-[#4caf50] border-l-4 border-white pl-2';
                            }
                            else if (event.includes(away.name)) {
                                currentAwayGoals++;
                                aScore.textContent = currentAwayGoals;
                                aScore.classList.add('score-pulse');
                                setTimeout(() => aScore.classList.remove('score-pulse'), 500);
                                line.className = 'ticker-line font-bold text-[#4caf50] border-l-4 border-white pl-2';
                            }
                        }
                        else if (event.includes('RED CARD')) {
                            line.className = 'ticker-line font-bold text-red-500 border-l-4 border-red-500 pl-2';
                            
                            if (event.includes(home.name)) {
                                hName.parentElement.classList.add('red-card-indicator');
                                setTimeout(() => hName.parentElement.classList.remove('red-card-indicator'), 1000);
                            } else if (event.includes(away.name)) {
                                aName.parentElement.classList.add('red-card-indicator');
                                setTimeout(() => aName.parentElement.classList.remove('red-card-indicator'), 1000);
                            }
                        }
                        else if (event.includes('INJURY')) {
                            line.className = 'ticker-line font-bold text-yellow-500 border-l-4 border-yellow-500 pl-2';
                        }
                        
                        if (feed.firstChild) {
                            feed.scrollTop = 0;
                        }
                    }

                    if (allEvents.length === 0 && step > 8) {
                        clearInterval(interval);
                        
                        // Исправлено: показываем все оставшиеся голы в конце матча
                        const finalHomeGoals = match.homeGoals;
                        const finalAwayGoals = match.awayGoals;
                        
                        // Функция для постепенного показа оставшихся голов
                        const showRemainingGoals = () => {
                            let goalsShown = false;
                            
                            // Проверяем голы домашней команды
                            while (currentHomeGoals < finalHomeGoals) {
                                currentHomeGoals++;
                                setTimeout(() => {
                                    hScore.textContent = currentHomeGoals;
                                    hScore.classList.add('score-pulse');
                                    setTimeout(() => hScore.classList.remove('score-pulse'), 300);
                                    
                                    const goalLine = document.createElement('div');
                                    goalLine.className = 'ticker-line font-bold text-[#4caf50] border-l-4 border-white pl-2';
                                    goalLine.textContent = `LATE GOAL! ${home.name} scores!`;
                                    feed.prepend(goalLine);
                                }, 400 * (currentHomeGoals - 1));
                                goalsShown = true;
                            }
                            
                            // Проверяем голы гостевой команды
                            while (currentAwayGoals < finalAwayGoals) {
                                currentAwayGoals++;
                                setTimeout(() => {
                                    aScore.textContent = currentAwayGoals;
                                    aScore.classList.add('score-pulse');
                                    setTimeout(() => aScore.classList.remove('score-pulse'), 300);
                                    
                                    const goalLine = document.createElement('div');
                                    goalLine.className = 'ticker-line font-bold text-[#4caf50] border-l-4 border-white pl-2';
                                    goalLine.textContent = `LATE GOAL! ${away.name} scores!`;
                                    feed.prepend(goalLine);
                                }, 400 * (currentAwayGoals - 1));
                                goalsShown = true;
                            }
                            
                            if (goalsShown) {
                                setTimeout(() => {
                                    timer.textContent = "FT";
                                    hScore.textContent = match.homeGoals;
                                    aScore.textContent = match.awayGoals;
                                    
                                    feed.prepend(Object.assign(document.createElement('div'), {
                                        className: 'ticker-line text-white font-bold text-center mt-2 uppercase tracking-widest',
                                        textContent: '--- FULL TIME ---'
                                    }));
                                    
                                    btn.classList.remove('hidden');
                                }, 800);
                            } else {
                                timer.textContent = "FT";
                                hScore.textContent = match.homeGoals;
                                aScore.textContent = match.awayGoals;
                                
                                feed.prepend(Object.assign(document.createElement('div'), {
                                    className: 'ticker-line text-white font-bold text-center mt-2 uppercase tracking-widest',
                                    textContent: '--- FULL TIME ---'
                                }));
                                
                                btn.classList.remove('hidden');
                            }
                        };
                        
                        showRemainingGoals();
                    }
                }, 350);

                btn.onclick = () => {
                    modal.classList.add('hidden');
                    resolve();
                };
            });
        }

        function processTransferMarket() {
            return new Promise(resolve => {
                if (Math.random() > 0.5) {
                    const cpuTeams = STATE.allTeams.filter(t => t.id !== STATE.userTeamId);
                    if (cpuTeams.length >= 2) {
                        const t1 = cpuTeams[Math.floor(Math.random() * cpuTeams.length)];
                        const t2 = cpuTeams[Math.floor(Math.random() * cpuTeams.length)];
                        if (t1 !== t2 && t1.squad.length > 15 && t2.squad.length > 15) {
                            const p = t1.squad[Math.floor(Math.random() * t1.squad.length)];
                            transferPlayer(p, t1, t2, p.price);
                            addNews('Transfer Market', `${t2.name} signed ${p.name} from ${t1.name}`, 'transfer');
                        }
                    }
                }

                if (Math.random() < 0.3) {
                    const userTeam = getTeam(STATE.userTeamId);
                    const listed = userTeam.squad.filter(p => p.transferListed);
                    if (listed.length > 0) {
                        const player = listed[Math.floor(Math.random() * listed.length)];
                        const cpuTeams = STATE.allTeams.filter(t => t.id !== STATE.userTeamId);
                        const buyer = cpuTeams[Math.floor(Math.random() * cpuTeams.length)];
                        const variance = 0.9 + Math.random() * 0.3; 
                        const offerPrice = Math.floor(player.price * variance);

                        resolve({ player, buyer, price: offerPrice });
                        return;
                    }
                }
                resolve(null);
            });
        }

        function transferPlayer(player, fromTeam, toTeam, price) {
            fromTeam.squad = fromTeam.squad.filter(p => p.internalId !== player.internalId);
            fromTeam.budget += price;
            player.clubId = toTeam.id;
            player.isStarter = false;
            player.transferListed = false;
            toTeam.squad.push(player);
            toTeam.budget -= price;
            
            if (fromTeam.id === STATE.userTeamId) {
                for (let i = 0; i < STATE.userLineupSlots.length; i++) {
                    if (STATE.userLineupSlots[i] === player.internalId) {
                        STATE.userLineupSlots[i] = null;
                    }
                }
                updateTeamStartersFromSlots(fromTeam);
            }
            
            calculateTeamRating(fromTeam);
            
            if (toTeam.id === STATE.userTeamId) {
            } else {
                if (!toTeam.squad.some(p => p.isStarter)) autoSelectStarters(toTeam);
            }
            calculateTeamRating(toTeam);
        }

        function handlePlayerSelect(internalId) {
            if (STATE.view !== 'tactics') return; 

            const userTeam = getTeam(STATE.userTeamId);
            const player = userTeam.squad.find(p => p.internalId === internalId);
            
            if (STATE.swapSelection === null) {
                STATE.swapSelection = internalId;
            } 
            else {
                const p1 = userTeam.squad.find(p => p.internalId === STATE.swapSelection);
                const p2 = player;
                
                if (p1 && p2 && p1 !== p2) {
                    const p1Unavail = p1.injuryWeeks > 0 || p1.isSuspended;
                    const p2Unavail = p2.injuryWeeks > 0 || p2.isSuspended;
                    
                    const p1ResultStarter = p2.isStarter;
                    const p2ResultStarter = p1.isStarter;

                    if ((p1Unavail && p1ResultStarter) || (p2Unavail && p2ResultStarter)) {
                        alert("Cannot put an injured/suspended player in the Starting XI!");
                        STATE.swapSelection = null;
                        renderDashboard();
                        return;
                    }

                    const temp = p1.isStarter;
                    p1.isStarter = p2.isStarter;
                    p2.isStarter = temp;
                    
                    const p1SlotIndex = STATE.userLineupSlots.indexOf(p1.internalId);
                    const p2SlotIndex = STATE.userLineupSlots.indexOf(p2.internalId);
                    
                    if (p1SlotIndex !== -1 && p2SlotIndex !== -1) {
                        STATE.userLineupSlots[p1SlotIndex] = p2.internalId;
                        STATE.userLineupSlots[p2SlotIndex] = p1.internalId;
                    }
                    
                    calculateTeamRating(userTeam);
                }
                STATE.swapSelection = null;
            }
            renderDashboard();
        }

        function toggleTransferList(internalId) {
            const userTeam = getTeam(STATE.userTeamId);
            const player = userTeam.squad.find(p => p.internalId === internalId);
            if (player) {
                player.transferListed = !player.transferListed;
                const btn = document.getElementById('transfer-list-btn');
                if(btn) {
                    btn.innerText = player.transferListed ? "Remove from List" : "Add to Transfer List";
                    btn.className = `w-full font-bold py-3 rounded-lg uppercase tracking-wider mb-2 ${player.transferListed ? 'bg-red-500 hover:bg-red-600' : 'bg-blue-500 hover:bg-blue-600'}`;
                }
                if(STATE.view === 'squad') renderDashboard();
            }
        }

        function openTransferConfirm(internalId) {
            let player = null;
            let fromTeam = null;
            for (const t of STATE.allTeams) {
                const p = t.squad.find(x => x.internalId === internalId);
                if (p) { player = p; fromTeam = t; break; }
            }
            if (!player || !fromTeam) return;

            const userTeam = getTeam(STATE.userTeamId);
            if (userTeam.budget < player.price) {
                alert("Insufficient Funds!");
                return;
            }

            pendingTransfer = { player, fromTeam, userTeam };

            document.getElementById('tc-player-name').textContent = player.name;
            document.getElementById('tc-club-name').textContent = fromTeam.name;
            document.getElementById('tc-current-budget').textContent = formatMoney(userTeam.budget);
            document.getElementById('tc-transfer-fee').textContent = '- ' + formatMoney(player.price);
            
            const remaining = userTeam.budget - player.price;
            const remEl = document.getElementById('tc-remaining');
            remEl.textContent = formatMoney(remaining);
            remEl.className = remaining < 5000000 ? 'font-bold text-yellow-500' : 'font-bold text-emerald-400';

            document.getElementById('btn-confirm-transfer').onclick = executeTransfer;
            document.getElementById('transfer-confirm-overlay').classList.remove('hidden');
        }

        function closeTransferModal() {
            document.getElementById('transfer-confirm-overlay').classList.add('hidden');
            pendingTransfer = null;
        }

        function executeTransfer() {
            if (!pendingTransfer) return;
            const { player, fromTeam, userTeam } = pendingTransfer;
            transferPlayer(player, fromTeam, userTeam, player.price);
            closeTransferModal();
            addNews('Transfer News', `You signed ${player.name} from ${fromTeam.name} for ${formatMoney(player.price)}`, 'transfer');
            showSigningReveal(player);
            renderDashboard();
        }

        function showSigningReveal(player) {
            const overlay = document.getElementById('signing-overlay');
            const card = document.getElementById('reveal-card');
            const club = getTeam(STATE.userTeamId);

            card.innerHTML = `
                <div class="flex justify-between items-start mb-6 relative z-10">
                    <div class="flex flex-col">
                        <span class="text-4xl font-black ${player.rating >= 90 ? 'text-[#fbbf24]' : 'text-white'}">${player.rating}</span>
                        <span class="text-lg font-bold opacity-80 text-white">${player.pos}</span>
                        <span class="text-xs text-slate-400 mt-1">Potential: ${player.potential || 'N/A'}</span>
                    </div>
                </div>
                <div class="text-center mb-6 relative z-10">
                    <h2 class="text-3xl font-black uppercase tracking-wider truncate text-transparent bg-clip-text bg-gradient-to-b from-white to-slate-400 mb-2">
                        ${player.name}
                    </h2>
                    <div class="w-16 h-1 bg-[#4caf50] mx-auto rounded-full"></div>
                </div>
                <div class="grid grid-cols-2 gap-y-2 gap-x-4 text-sm font-bold relative z-10 border-t border-white/10 py-4 text-white">
                    <div class="flex justify-between"> <span class="opacity-70">PAC</span> <span>${player.speed}</span> </div>
                    <div class="flex justify-between"> <span class="opacity-70">DRI</span> <span>${player.dribble}</span> </div>
                    <div class="flex justify-between"> <span class="opacity-70">SHO</span> <span>${player.shot}</span> </div>
                    <div class="flex justify-between"> <span class="opacity-70">PAS</span> <span>${player.pass}</span> </div>
                </div>
            `;
            
            overlay.classList.remove('hidden');
        }

        function closeSigningReveal() {
            document.getElementById('signing-overlay').classList.add('hidden');
        }

        function openPlayerProfile(internalId, event) {
            if(event) event.stopPropagation();
            
            let player = null;
            let club = null;

            for(const t of STATE.allTeams) {
                const p = t.squad.find(pl => pl.internalId === internalId);
                if (p) { player = p; club = t; break; }
            }
            if (!player) return;

            const overlay = document.getElementById('profile-overlay');
            const content = document.getElementById('profile-content');
            
            const getAttrClass = (val) => val >= 90 ? 'gold' : (val >= 80 ? 'text-emerald-400' : 'text-slate-300');
            const isUserPlayer = club.id === STATE.userTeamId;
            
            let statusBadge = '';
            if (player.injuryWeeks > 0) statusBadge = `<div class="absolute top-2 right-2 bg-red-600 text-white px-2 py-1 rounded text-xs font-bold shadow-lg">🩹 ${player.injuryWeeks} Wks</div>`;
            else if (player.isSuspended) statusBadge = `<div class="absolute top-2 right-2 bg-red-600 text-white px-2 py-1 rounded text-xs font-bold shadow-lg">🟥 Suspended</div>`;

            content.innerHTML = `
                <div class="fut-card w-80 rounded-2xl p-6 text-white select-none transform transition-transform hover:scale-105 duration-300">
                    ${statusBadge}
                    <div class="flex justify-between items-start mb-6 relative z-10">
                        <div class="flex flex-col">
                            <span class="text-4xl font-black ${getAttrClass(player.rating)}">${player.rating}</span>
                            <span class="text-lg font-bold opacity-80">${player.pos}</span>
                            <span class="text-xs text-slate-400 mt-1">Potential: ${player.potential || 'N/A'}</span>
                        </div>
                        <div class="flex flex-col items-end">
                            <div class="w-12 h-12 rounded-full flex items-center justify-center text-sm font-bold shadow-lg ring-2 ring-slate-600 bg-slate-800" style="border-bottom: 3px solid ${club.color}">
                                ${club.name.substring(0,2).toUpperCase()}
                            </div>
                        </div>
                    </div>

                    <div class="text-center mb-6 relative z-10">
                        <h2 class="text-2xl font-black uppercase tracking-wider truncate text-transparent bg-clip-text bg-gradient-to-b from-white to-slate-400">
                            ${player.name}
                        </h2>
                        <div class="text-xs text-slate-400 mt-1 font-mono flex justify-center gap-3">
                            <span>Age: ${player.age}</span>
                            <span>Value: ${formatMoney(player.price)}</span>
                        </div>
                        ${player.nation ? `<div class="text-xs text-slate-500 mt-1 font-mono uppercase">${player.nation}</div>` : ''}
                    </div>

                    <div class="grid grid-cols-2 gap-y-2 gap-x-4 text-sm font-bold mb-6 relative z-10 border-t border-b border-white/10 py-4">
                        <div class="flex justify-between"> <span class="opacity-70">PAC</span> <span class="${getAttrClass(player.speed)}">${player.speed}</span> </div>
                        <div class="flex justify-between"> <span class="opacity-70">DRI</span> <span class="${getAttrClass(player.dribble)}">${player.dribble}</span> </div>
                        <div class="flex justify-between"> <span class="opacity-70">SHO</span> <span class="${getAttrClass(player.shot)}">${player.shot}</span> </div>
                        <div class="flex justify-between"> <span class="opacity-70">PAS</span> <span class="${getAttrClass(player.pass)}">${player.pass}</span> </div>
                    </div>

                    <div class="relative z-10 bg-black/30 rounded-lg p-3 grid grid-cols-3 gap-2 text-center mb-4">
                        <div>
                            <div class="text-2xl font-black text-[#4caf50]">${player.seasonGoals}</div>
                            <div class="text-[10px] uppercase tracking-widest opacity-60">Season Goals</div>
                        </div>
                        <div>
                            <div class="text-2xl font-black text-blue-400">${player.seasonAssists}</div>
                            <div class="text-[10px] uppercase tracking-widest opacity-60">Season Assists</div>
                        </div>
                        <div>
                            <div class="text-2xl font-black text-yellow-400">${Math.round(player.seasonRating)}</div>
                            <div class="text-[10px] uppercase tracking-widest opacity-60">Season Rating</div>
                        </div>
                    </div>
                    
                    <div class="relative z-10 bg-slate-900/50 rounded-lg p-3 text-center mb-4">
                        <div class="text-xl font-black text-white">${player.careerGoals}</div>
                        <div class="text-[10px] uppercase tracking-widest opacity-60">Career Goals</div>
                    </div>

                    ${isUserPlayer ? `
                        <button id="transfer-list-btn" onclick="toggleTransferList(${player.internalId})" class="relative z-10 w-full font-bold py-3 rounded-lg uppercase tracking-wider text-xs ${player.transferListed ? 'bg-red-500 hover:bg-red-600' : 'bg-blue-500 hover:bg-blue-600'}">
                            ${player.transferListed ? 'Remove from List' : 'Add to Transfer List'}
                        </button>
                    ` : ''}
                </div>
            `;
            
            overlay.classList.remove('hidden');
        }

        function closeProfile(event) {
            document.getElementById('profile-overlay').classList.add('hidden');
        }

        function renderUploadScreen() {
            document.getElementById('app').innerHTML = `
                <div class="w-full flex flex-col items-center justify-center p-6 bg-slate-900">
                    <div class="glass-panel p-10 rounded-2xl max-w-2xl w-full text-center shadow-2xl">
                        <h1 class="text-4xl font-black mb-4 text-transparent bg-clip-text bg-gradient-to-r from-[#4caf50] to-cyan-400">PRO MANAGER DYNASTY</h1>
                        <p class="text-slate-400 mb-8">Select Database (JSON/SQLite) or Save File to begin.</p>
                        <label class="cursor-pointer block w-full border-2 border-dashed border-slate-600 hover:border-[#4caf50] rounded-xl p-12 transition-all hover:bg-slate-800/50">
                            <div class="flex flex-col items-center">
                                <span class="text-lg font-bold text-slate-300">Upload File</span>
                            </div>
                            <input type="file" accept=".json,.db,.sqlite" class="hidden" onchange="handleFileUpload(event)">
                        </label>
                    </div>
                </div>
            `;
        }

        function renderTeamSelection() {
            const leagues = {};
            STATE.allTeams.forEach(t => {
                const leagueId = t.leagueId;
                const leagueInfo = STATE.leaguesMap.get(leagueId) || { 
                    name: t.leagueName || 'Other League',
                    division: 1,
                    nation: 'INT',
                    promotions: 3,
                    directPromotions: 3,
                    relegations: 3
                };
                
                let displayName = leagueInfo.name;
                if (leagueInfo.division && leagueInfo.nation) {
                    displayName += ` (Div ${leagueInfo.division}, ${leagueInfo.nation})`;
                } else if (leagueInfo.division) {
                    displayName += ` (Div ${leagueInfo.division})`;
                }
                
                if (!leagues[displayName]) {
                    leagues[displayName] = {
                        teams: [],
                        leagueId: leagueId,
                        leagueInfo: leagueInfo
                    };
                }
                leagues[displayName].teams.push(t);
            });

            const sortedLeagues = Object.keys(leagues).sort((a, b) => {
                const leagueA = leagues[a].leagueInfo;
                const leagueB = leagues[b].leagueInfo;
                
                if (leagueA.nation !== leagueB.nation) {
                    return (leagueA.nation || '').localeCompare(leagueB.nation || '');
                }
                if (leagueA.division !== leagueB.division) {
                    return (leagueA.division || 99) - (leagueB.division || 99);
                }
                return (leagueA.name || '').localeCompare(leagueB.name || '');
            });

            let html = `
                <div class="w-full h-full overflow-y-auto bg-[#1a1a1a]">
                    <div class="max-w-4xl mx-auto p-8">
                        <h2 class="text-3xl font-black mb-8 text-white text-center">SELECT CLUB</h2>
                        <div class="space-y-4">
            `;

            sortedLeagues.forEach((displayName, i) => {
                const leagueData = leagues[displayName];
                html += `
                    <div class="bg-slate-800 rounded-xl overflow-hidden border border-slate-700">
                        <button onclick="toggleLeague('l-${i}')" class="w-full px-6 py-4 flex justify-between items-center hover:bg-slate-750 transition-colors">
                            <div class="flex flex-col items-start">
                                <span class="font-bold text-lg text-white">${displayName}</span>
                                <span class="text-xs text-slate-500">${leagueData.teams.length} teams • Div ${leagueData.leagueInfo.division}</span>
                            </div>
                            <span class="text-slate-500">▼</span>
                        </button>
                        <div id="l-${i}" class="accordion-content bg-[#121212]">
                            <div class="p-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
                                ${leagueData.teams.map(t => `
                                    <div onclick="selectTeam('${t.id}')" class="cursor-pointer bg-slate-800 hover:bg-[#4caf50]/20 border border-slate-700 hover:border-[#4caf50] p-4 rounded-lg flex justify-between items-center group transition-all">
                                        <span class="font-bold text-slate-200 group-hover:text-white">${t.name}</span>
                                        <div class="flex items-center gap-3">
                                            <span class="text-xs text-slate-500">${t.teamRating}</span>
                                            <div class="w-3 h-3 rounded-full" style="background-color: ${t.color}"></div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `</div></div></div>`;
            document.getElementById('app').innerHTML = html;
        }

        function toggleLeague(id) {
            const el = document.getElementById(id);
            if (el.classList.contains('open')) el.classList.remove('open');
            else el.classList.add('open');
        }

        function selectTeam(id) {
            console.log("Selecting team with id:", id);
            STATE.userTeamId = id;
            const t = getTeam(id);
            
            if (!t) {
                console.error("Team not found with id:", id);
                alert("Error: Team not found!");
                return;
            }
            
            console.log("Selected team:", t.name);
            STATE.activeLeagueTeams = STATE.allTeams.filter(x => x.leagueId === t.leagueId);
            initSchedule();
            renderDashboard();
        }

        function renderDashboard() {
            const userTeam = getTeam(STATE.userTeamId);
            if (!userTeam) {
                console.error("User team not found!");
                renderTeamSelection();
                return;
            }
            
            const isFinished = STATE.currentWeek >= STATE.schedule.length;

            document.getElementById('app').innerHTML = `
                <aside class="w-64 bg-slate-800 border-r border-slate-700 flex flex-col z-20 shrink-0">
                    <div class="h-20 flex items-center px-6 border-b border-slate-700 bg-slate-900/50">
                        <span class="font-black text-xl italic text-[#4caf50]">MANAGER 25</span>
                    </div>
                    <div class="p-6 border-b border-slate-700/50">
                        <div class="text-2xl font-black text-white leading-none mb-2">${userTeam.name}</div>
                        <div class="text-xs font-mono text-slate-500 mb-2 truncate">${userTeam.stadiumName}</div>
                        <div class="text-sm font-bold text-emerald-400 mb-1">${formatMoney(userTeam.budget)}</div>
                        <div class="text-xs font-mono text-slate-400">Week ${STATE.currentWeek} / ${STATE.totalWeeks}</div>
                    </div>
                    <nav class="flex-grow py-4 space-y-1 overflow-y-auto">
                        ${navBtn('next-match', 'Fixtures')}
                        ${navBtn('tactics', 'Tactics & Squad')}
                        ${navBtn('table', 'League Table')}
                        ${navBtn('squad', 'My Squad')}
                        ${navBtn('market', 'Transfer Market')}
                        ${navBtn('stats', 'League Stats')}
                        ${navBtn('trophy', 'Trophy Room')}
                        ${navBtn('news', 'News Center')}
                    </nav>
                    <div class="p-4 border-t border-slate-700 bg-slate-900/30">
                        <button onclick="saveGame()" class="w-full flex items-center justify-center gap-2 bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 rounded-lg uppercase tracking-wider text-xs transition-colors shadow-lg">
                            <span>💾</span> SAVE GAME
                        </button>
                    </div>
                </aside>

                <main class="flex-grow bg-[#1a1a1a] flex flex-col h-full overflow-hidden relative">
                    <header class="h-20 border-b border-slate-800 bg-slate-900/80 backdrop-blur flex items-center justify-between px-8 shrink-0 z-30">
                        <button class="mobile-menu-btn" onclick="toggleMobileNav()">MENU</button>
                        <h2 class="text-xl font-bold text-white uppercase tracking-wide">${getHeaderTitle()}</h2>
                        <button id="playWeekBtn" ${isFinished ? 'disabled' : ''} 
                            class="bg-[#4caf50] hover:bg-[#43a047] disabled:opacity-50 disabled:cursor-not-allowed text-white px-8 py-3 rounded-lg font-black shadow-lg shadow-green-900/30 transition-all active:scale-95 uppercase tracking-wider">
                            ${isFinished ? 'Season Over' : `Play Week ${STATE.currentWeek + 1}`}
                        </button>
                    </header>
                    <div class="p-8 overflow-y-auto h-full pb-24">
                        ${getMainContent(userTeam, isFinished)}
                    </div>
                </main>
            `;
        }

        function navBtn(view, label) {
            const active = STATE.view === view ? 'bg-[#4caf50]/10 text-[#4caf50] border-r-4 border-[#4caf50]' : 'text-slate-400 hover:text-white hover:bg-slate-700/50';
            return `<button onclick="closeMobileNav(); STATE.view='${view}'; STATE.swapSelection=null; STATE.slotSelection=null; renderDashboard()" class="w-full text-left px-6 py-4 font-bold transition-all min-h-[44px] flex items-center ${active}">${label}</button>`;
        }

        function getHeaderTitle() {
            if (STATE.view === 'next-match') return 'Matchday Center';
            if (STATE.view === 'tactics') return 'Team Management';
            if (STATE.view === 'table') return 'League Standings';
            if (STATE.view === 'squad') return 'Squad List';
            if (STATE.view === 'market') return 'Transfer Market';
            if (STATE.view === 'stats') return 'League Statistics';
            if (STATE.view === 'trophy') return 'Club History';
            if (STATE.view === 'news') return 'News Center';
            return 'Dashboard';
        }

        function getMainContent(userTeam, isFinished) {
            if (STATE.view === 'news') {
                if (STATE.newsFeed.length === 0) {
                    return `<div class="text-center text-slate-500 py-20 italic">No news yet.</div>`;
                }
                return `
                    <div class="glass-panel rounded-xl overflow-hidden p-6 max-w-3xl mx-auto">
                        <h3 class="text-2xl font-bold text-white mb-6 border-b border-slate-700 pb-2">Latest News</h3>
                        <div class="space-y-3">
                            ${STATE.newsFeed.map(item => `
                                <div class="bg-slate-800/50 p-4 rounded-lg flex gap-4 type-${item.type}">
                                    <div class="flex-grow">
                                        <div class="flex justify-between items-start">
                                            <h4 class="font-bold text-white">${item.title}</h4>
                                            <span class="text-xs font-mono text-slate-500">S${item.season} W${item.week}</span>
                                        </div>
                                        <p class="text-slate-300 text-sm mt-1">${item.msg}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            if (STATE.view === 'stats') {
                calculateLeagueStats();
                return `
                    <div class="glass-panel rounded-xl p-6">
                        <h3 class="text-2xl font-bold text-white mb-6 border-b border-slate-700 pb-2">League Statistics - Season ${STATE.season}</h3>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                            <div class="bg-slate-800/50 rounded-xl p-6 border border-slate-700">
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-10 h-10 rounded-full flex items-center justify-center award-badge">
                                        <span class="text-lg">⚽</span>
                                    </div>
                                    <div>
                                        <h3 class="text-xl font-bold text-white">Top Scorers</h3>
                                        <p class="text-slate-400 text-sm">Golden Boot Race</p>
                                    </div>
                                </div>
                                <div class="space-y-3">
                                    ${STATE.leagueStats.topScorers.length > 0 ? 
                                        STATE.leagueStats.topScorers.map((player, index) => `
                                            <div class="flex items-center justify-between p-3 rounded-lg ${index < 3 ? 'bg-slate-900/70 hover:bg-slate-900' : 'bg-slate-900/30 hover:bg-slate-900/50'}">
                                                <div class="flex items-center gap-3">
                                                    <span class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${index === 0 ? 'award-badge' : index === 1 ? 'bg-slate-600' : index === 2 ? 'bg-amber-800' : 'bg-slate-700'}">
                                                        ${index + 1}
                                                    </span>
                                                    <div>
                                                        <div class="font-bold text-slate-200 flex items-center gap-2">
                                                            ${player.name}
                                                            ${index === 0 ? '<span class="text-xs award-badge px-2 py-0.5 rounded">🏆</span>' : ''}
                                                        </div>
                                                        <div class="text-xs text-slate-400">${player.teamName} • ${player.pos}</div>
                                                    </div>
                                                </div>
                                                <div class="text-right">
                                                    <div class="text-xl font-black ${index === 0 ? 'text-yellow-400' : 'text-white'}">${player.seasonGoals}</div>
                                                    <div class="text-xs text-slate-400">goals</div>
                                                </div>
                                            </div>
                                        `).join('') :
                                        '<div class="text-center text-slate-500 py-4">No goals scored yet</div>'
                                    }
                                </div>
                            </div>
                            
                            <div class="bg-slate-800/50 rounded-xl p-6 border border-slate-700">
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-10 h-10 rounded-full flex items-center justify-center award-badge">
                                        <span class="text-lg">🎯</span>
                                    </div>
                                    <div>
                                        <h3 class="text-xl font-bold text-white">Top Assists</h3>
                                        <p class="text-slate-400 text-sm">Playmaker Award</p>
                                    </div>
                                </div>
                                <div class="space-y-3">
                                    ${STATE.leagueStats.topAssists.length > 0 ? 
                                        STATE.leagueStats.topAssists.map((player, index) => `
                                            <div class="flex items-center justify-between p-3 rounded-lg ${index < 3 ? 'bg-slate-900/70 hover:bg-slate-900' : 'bg-slate-900/30 hover:bg-slate-900/50'}">
                                                <div class="flex items-center gap-3">
                                                    <span class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${index === 0 ? 'award-badge' : index === 1 ? 'bg-slate-600' : index === 2 ? 'bg-amber-800' : 'bg-slate-700'}">
                                                        ${index + 1}
                                                    </span>
                                                    <div>
                                                        <div class="font-bold text-slate-200 flex items-center gap-2">
                                                            ${player.name}
                                                            ${index === 0 ? '<span class="text-xs award-badge px-2 py-0.5 rounded">🎯</span>' : ''}
                                                        </div>
                                                        <div class="text-xs text-slate-400">${player.teamName} • ${player.pos}</div>
                                                    </div>
                                                </div>
                                        <div class="text-right">
                                            <div class="text-xl font-black ${index === 0 ? 'text-yellow-400' : 'text-white'}">${player.seasonAssists}</div>
                                            <div class="text-xs text-slate-400">assists</div>
                                        </div>
                                    </div>
                                `).join('') :
                                '<div class="text-center text-slate-500 py-4">No assists yet</div>'
                            }
                        </div>
                    </div>
                    
                    <div class="bg-slate-800/50 rounded-xl p-6 border border-slate-700">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center award-badge">
                                <span class="text-lg">⭐</span>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-white">Best Players</h3>
                                <p class="text-slate-400 text-sm">Season Rating</p>
                            </div>
                        </div>
                        <div class="space-y-3">
                            ${STATE.leagueStats.bestPlayers.length > 0 ? 
                                STATE.leagueStats.bestPlayers.map((player, index) => `
                                    <div class="flex items-center justify-between p-3 rounded-lg ${index < 3 ? 'bg-slate-900/70 hover:bg-slate-900' : 'bg-slate-900/30 hover:bg-slate-900/50'}">
                                        <div class="flex items-center gap-3">
                                            <span class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${index === 0 ? 'award-badge' : index === 1 ? 'bg-slate-600' : index === 2 ? 'bg-amber-800' : 'bg-slate-700'}">
                                                ${index + 1}
                                            </span>
                                            <div>
                                                <div class="font-bold text-slate-200 flex items-center gap-2">
                                                    ${player.name}
                                                    ${index === 0 ? '<span class="text-xs award-badge px-2 py-0.5 rounded">⭐</span>' : ''}
                                                </div>
                                                <div class="text-xs text-slate-400">${player.teamName} • ${player.pos}</div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-xl font-black ${index === 0 ? 'text-yellow-400' : 'text-white'}">${Math.round(player.seasonRating)}</div>
                                            <div class="text-xs text-slate-400">rating</div>
                                        </div>
                                    </div>
                                `).join('') :
                                '<div class="text-center text-slate-500 py-4">Not enough matches played</div>'
                            }
                        </div>
                    </div>
                </div>
                
                <div class="bg-slate-800/30 rounded-xl p-6 border border-slate-700">
                    <h3 class="text-xl font-bold text-white mb-4">Your Team Performance</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center">
                            <div class="text-3xl font-black text-[#4caf50]">${userTeam.points}</div>
                            <div class="text-slate-400 text-sm">Points</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-black text-white">${userTeam.gf}</div>
                            <div class="text-slate-400 text-sm">Goals For</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-black text-white">${userTeam.ga}</div>
                            <div class="text-slate-400 text-sm">Goals Against</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-black text-white">${userTeam.gd}</div>
                            <div class="text-slate-400 text-sm">Goal Difference</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
            }

            if (STATE.view === 'trophy') {
                return `
                    <div class="glass-panel rounded-xl p-8 min-h-[50vh]">
                        <h3 class="text-2xl font-bold text-white mb-6 border-b border-slate-700 pb-2">Club History</h3>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                            <div class="bg-slate-800/50 rounded-xl p-6">
                                <h4 class="text-lg font-bold text-slate-300 mb-4">Trophy Cabinet</h4>
                                ${STATE.history.length === 0 
                                    ? `<div class="text-center text-slate-500 py-8 italic">No trophies yet. Win the league to fill this space!</div>` 
                                    : `<div class="space-y-4">
                                        ${STATE.history.map(h => `
                                            <div class="bg-slate-900/50 p-4 rounded-lg flex items-center gap-4 border border-yellow-500/20">
                                                <div class="text-3xl">🏆</div>
                                                <div>
                                                    <div class="font-black text-yellow-400 text-lg">Season ${h.year}</div>
                                                    <div class="text-sm text-slate-300">${h.title}</div>
                                                </div>
                                            </div>
                                        `).join('')}
                                       </div>`
                                }
                            </div>
                            
                            <div class="bg-slate-800/50 rounded-xl p-6 lg:col-span-2">
                                <h4 class="text-lg font-bold text-slate-300 mb-4">Awards History</h4>
                                ${STATE.leagueStats.awardsHistory.length > 0 ? 
                                    `<div class="space-y-4">
                                        ${STATE.leagueStats.awardsHistory.map(award => `
                                            <div class="bg-slate-900/50 p-4 rounded-lg border border-slate-700">
                                                <div class="font-bold text-slate-300 mb-2 text-lg">Season ${award.season} Awards</div>
                                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                                    <div class="flex flex-col items-center p-3 bg-slate-800/30 rounded">
                                                        <div class="text-2xl mb-1">⚽</div>
                                                        <div class="text-sm text-slate-400 mb-1">Golden Boot</div>
                                                        <div class="font-bold text-white text-center">${award.goldenBoot?.player || 'N/A'}</div>
                                                        <div class="text-xs text-slate-500">${award.goldenBoot?.goals || 0} goals</div>
                                                    </div>
                                                    <div class="flex flex-col items-center p-3 bg-slate-800/30 rounded">
                                                        <div class="text-2xl mb-1">🎯</div>
                                                        <div class="text-sm text-slate-400 mb-1">Playmaker</div>
                                                        <div class="font-bold text-white text-center">${award.playmaker?.player || 'N/A'}</div>
                                                        <div class="text-xs text-slate-500">${award.playmaker?.assists || 0} assists</div>
                                                    </div>
                                                    <div class="flex flex-col items-center p-3 bg-slate-800/30 rounded">
                                                        <div class="text-2xl mb-1">⭐</div>
                                                        <div class="text-sm text-slate-400 mb-1">Player of the Season</div>
                                                        <div class="font-bold text-white text-center">${award.bestPlayer?.player || 'N/A'}</div>
                                                        <div class="text-xs text-slate-500">Rating: ${award.bestPlayer?.rating || 'N/A'}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>` :
                                    '<div class="text-center text-slate-500 py-8 italic">No awards history yet. Complete a season to see awards!</div>'
                                }
                            </div>
                        </div>
                    </div>
                `;
            }

            if (STATE.view === 'market') {
                let players = [];
                for(const t of STATE.allTeams) {
                    if(t.id === userTeam.id) continue;
                    for(const p of t.squad) {
                        let match = true;
                        if (STATE.market.posFilter !== 'ALL') {
                            const cat = getPosCategory(p.pos);
                            if (STATE.market.posFilter === 'GK' && cat !== 1) match = false;
                            else if (STATE.market.posFilter === 'DEF' && cat !== 2) match = false;
                            else if (STATE.market.posFilter === 'MID' && cat !== 3) match = false;
                            else if (STATE.market.posFilter === 'FWD' && cat !== 4) match = false;
                        }
                        
                        if (STATE.market.search.trim() !== '') {
                            const searchTerm = STATE.market.search.toLowerCase().trim();
                            const playerName = p.name.toLowerCase();
                            if (!playerName.includes(searchTerm)) {
                                match = false;
                            }
                        }
                        
                        if(match) players.push(p);
                    }
                }

                if (STATE.market.sort === 'RATING') players.sort((a,b) => b.rating - a.rating);
                else if (STATE.market.sort === 'PRICE') players.sort((a,b) => b.price - a.price);
                
                const startIndex = (STATE.market.page - 1) * STATE.market.perPage;
                const paginatedPlayers = players.slice(startIndex, startIndex + STATE.market.perPage);
                const totalPages = Math.ceil(players.length / STATE.market.perPage);

                const btnClass = (active) => `filter-btn ${active ? 'active' : ''}`;

                return `
                    <div class="glass-panel rounded-xl overflow-hidden flex flex-col h-full">
                        <div class="p-4 bg-slate-800/80 border-b border-slate-700 flex flex-col gap-4">
                            <div class="flex gap-2 items-center">
                                <div class="relative flex-grow">
                                    <input 
                                        type="text" 
                                        id="market-search" 
                                        placeholder="Search players..." 
                                        value="${STATE.market.search}"
                                        class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 text-white text-sm focus:outline-none focus:ring-2 focus:ring-[#4caf50]"
                                        oninput="handleMarketSearch(event)"
                                    >
                                    ${STATE.market.search ? `
                                        <button onclick="clearMarketSearch()" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-white">
                                            ✕
                                        </button>
                                    ` : ''}
                                </div>
                                <button onclick="clearMarketSearch()" class="filter-btn">
                                    Clear
                                </button>
                            </div>
                            <div class="flex justify-between items-center">
                                <div class="flex gap-2">
                                    <button onclick="STATE.market.posFilter='ALL'; STATE.market.page=1; renderDashboard()" class="${btnClass(STATE.market.posFilter==='ALL')}">All</button>
                                    <button onclick="STATE.market.posFilter='GK'; STATE.market.page=1; renderDashboard()" class="${btnClass(STATE.market.posFilter==='GK')}">GK</button>
                                    <button onclick="STATE.market.posFilter='DEF'; STATE.market.page=1; renderDashboard()" class="${btnClass(STATE.market.posFilter==='DEF')}">DEF</button>
                                    <button onclick="STATE.market.posFilter='MID'; STATE.market.page=1; renderDashboard()" class="${btnClass(STATE.market.posFilter==='MID')}">MID</button>
                                    <button onclick="STATE.market.posFilter='FWD'; STATE.market.page=1; renderDashboard()" class="${btnClass(STATE.market.posFilter==='FWD')}">FWD</button>
                                </div>
                                <div class="flex gap-2">
                                    <span class="text-xs font-bold text-slate-500 uppercase self-center mr-2">Sort By:</span>
                                    <button onclick="STATE.market.sort='RATING'; STATE.market.page=1; renderDashboard()" class="${btnClass(STATE.market.sort==='RATING')}">Rating</button>
                                    <button onclick="STATE.market.sort='PRICE'; STATE.market.page=1; renderDashboard()" class="${btnClass(STATE.market.sort==='PRICE')}">Price</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="overflow-y-auto flex-grow">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-900 text-xs uppercase text-slate-400 sticky top-0 z-10 shadow-lg">
                                    <tr>
                                        <th class="px-6 py-4">Player</th>
                                        <th class="px-6 py-4 text-center">Pos</th>
                                        <th class="px-6 py-4 text-center">Age</th>
                                        <th class="px-6 py-4 text-center">OVR</th>
                                        <th class="px-6 py-4 text-center">POT</th>
                                        <th class="px-6 py-4 text-right">Value</th>
                                        <th class="px-6 py-4 text-center">Action</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-700/50">
                                    ${paginatedPlayers.length > 0 ? paginatedPlayers.map(p => `
                                        <tr class="hover:bg-slate-800/30 group">
                                            <td class="px-6 py-3 font-medium text-slate-200">
                                                <span class="clickable-name" onclick="openPlayerProfile(${p.internalId})">${p.name}</span>
                                                <div class="flex items-center gap-2 mt-0.5">
                                                    ${p.nation ? `<span class="text-[10px] bg-slate-700 px-1 rounded text-slate-300 font-mono">${p.nation.substring(0,3).toUpperCase()}</span>` : ''}
                                                    <div class="text-[10px] text-slate-500">${getTeam(p.clubId).name}</div>
                                                </div>
                                            </td>
                                            <td class="px-6 py-3 text-center"><span class="px-2 py-0.5 rounded text-xs font-bold ${getPosColor(p.pos)} bg-opacity-10">${p.pos}</span></td>
                                            <td class="px-6 py-3 text-center text-slate-400">${p.age}</td>
                                            <td class="px-6 py-3 text-center font-bold text-white">${p.rating}</td>
                                            <td class="px-6 py-3 text-center font-bold ${p.potential > p.rating ? 'text-emerald-400' : p.potential === p.rating ? 'text-slate-400' : 'text-red-400'}">${p.potential || p.rating}</td>
                                            <td class="px-6 py-3 text-right font-mono text-emerald-400">${formatMoney(p.price)}</td>
                                            <td class="px-6 py-3 text-center">
                                                <button onclick="openTransferConfirm(${p.internalId})" class="bg-slate-700 hover:bg-[#4caf50] text-white text-xs font-bold px-3 py-1.5 rounded transition-colors uppercase">Buy</button>
                                            </td>
                                        </tr>
                                    `).join('') : `
                                        <tr>
                                            <td colspan="7" class="px-6 py-8 text-center text-slate-500">
                                                ${players.length === 0 ? 'No players found' : 'No players on this page'}
                                            </td>
                                        </tr>
                                    `}
                                </tbody>
                            </table>
                        </div>
                        
                        ${totalPages > 1 ? `
                            <div class="p-4 bg-slate-800/50 border-t border-slate-700 flex justify-between items-center">
                                <div class="text-sm text-slate-400">
                                    Showing ${startIndex + 1}-${Math.min(startIndex + STATE.market.perPage, players.length)} of ${players.length} players
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="changeMarketPage(${STATE.market.page - 1})" ${STATE.market.page <= 1 ? 'disabled' : ''} 
                                        class="px-3 py-1 rounded bg-slate-700 text-slate-300 text-sm ${STATE.market.page <= 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-slate-600'}">
                                        Previous
                                    </button>
                                    <span class="px-3 py-1 text-sm text-slate-300">
                                        Page ${STATE.market.page} of ${totalPages}
                                    </span>
                                    <button onclick="changeMarketPage(${STATE.market.page + 1})" ${STATE.market.page >= totalPages ? 'disabled' : ''} 
                                        class="px-3 py-1 rounded bg-slate-700 text-slate-300 text-sm ${STATE.market.page >= totalPages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-slate-600'}">
                                        Next
                                    </button>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            if (STATE.view === 'next-match') {
                if(isFinished) return `<div class="text-center text-2xl font-bold text-slate-500 mt-20">Season Completed. Check Results.</div>`;
                const match = STATE.schedule[STATE.currentWeek].find(m => m.home === userTeam.id || m.away === userTeam.id);
                if (!match) return `<div>No match this week</div>`;
                const oppId = match.home === userTeam.id ? match.away : match.home;
                const opp = getTeam(oppId);
                const isHome = match.home === userTeam.id;

                return `
                    <div class="max-w-4xl mx-auto mt-10">
                        <div class="glass-panel rounded-3xl p-12 text-center relative overflow-hidden group">
                            <div class="absolute inset-0 bg-gradient-to-br from-[#4caf50]/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-700"></div>
                            <h3 class="text-[#4caf50] font-bold tracking-[0.2em] text-sm uppercase mb-12">Upcoming Fixture</h3>
                            
                            <div class="flex items-center justify-center gap-16">
                                <div class="w-1/3 flex flex-col items-center">
                                    <div class="w-32 h-32 rounded-full mb-6 flex items-center justify-center text-4xl font-black shadow-2xl ring-4 ring-slate-800" style="background-color: ${userTeam.color}; color:white">${userTeam.name.substring(0,2)}</div>
                                    <h2 class="text-3xl font-black text-white">${userTeam.name}</h2>
                                    <span class="text-slate-500 font-mono mt-2 text-sm bg-slate-900 px-3 py-1 rounded border border-slate-700">${isHome ? 'HOME' : 'AWAY'}</span>
                                </div>
                                <div class="text-6xl font-black text-slate-700 italic opacity-40">VS</div>
                                <div class="w-1/3 flex flex-col items-center">
                                    <div class="w-32 h-32 rounded-full mb-6 flex items-center justify-center text-4xl font-black shadow-2xl ring-4 ring-slate-800" style="background-color: ${opp.color}; color:white">${opp.name.substring(0,2)}</div>
                                    <h2 class="text-3xl font-black text-white">${opp.name}</h2>
                                    <span class="text-slate-500 font-mono mt-2 text-sm bg-slate-900 px-3 py-1 rounded border border-slate-700">${!isHome ? 'HOME' : 'AWAY'}</span>
                                </div>
                            </div>
                            
                            <div class="mt-16 inline-flex gap-px bg-slate-700 rounded-lg overflow-hidden border border-slate-600">
                                <div class="bg-slate-800 px-8 py-4">
                                    <div class="text-xs text-slate-400 uppercase font-bold mb-1">Your Rating</div>
                                    <div class="text-2xl font-black text-white">${userTeam.teamRating}</div>
                                </div>
                                <div class="bg-slate-800 px-8 py-4">
                                    <div class="text-xs text-slate-400 uppercase font-bold mb-1">Opp Rating</div>
                                    <div class="text-2xl font-black text-white">${opp.teamRating}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            if (STATE.view === 'tactics') {
                const slotPositions = getSlotPositions();
                const validation = validateStartingXI(userTeam);
                const validationClass = validation.valid ? 'text-emerald-400' : 'text-red-400';
                const benchPlayers = getBenchPlayers(userTeam);
                
                return `
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 h-full">
                        <div class="glass-panel rounded-xl flex flex-col h-full overflow-hidden border-t-4 border-t-[#4caf50]">
                            <div class="p-4 bg-slate-900/50 flex justify-between items-center border-b border-slate-700">
                                <div>
                                    <h3 class="font-bold text-white">Starting XI</h3>
                                    <div class="text-xs ${validationClass} mt-1">${validation.message}</div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="bg-[#4caf50]/20 text-[#4caf50] px-3 py-1 rounded text-xs font-bold uppercase">Strength: ${userTeam.teamRating}</span>
                                    <button onclick="autoSelectBestXI(getTeam('${userTeam.id}')); renderDashboard();" 
                                            class="bg-blue-500 hover:bg-blue-600 text-white font-bold text-xs px-3 py-1 rounded uppercase transition-colors">
                                        AUTO BEST XI
                                    </button>
                                </div>
                            </div>
                            <div class="overflow-y-auto p-4 space-y-4 flex-grow">
                                <div class="mb-6">
                                    <h4 class="text-sm font-bold text-slate-400 mb-2 uppercase tracking-wider">GOALKEEPER (1)</h4>
                                    ${slotPositions[0] && renderSlotCard(0)}
                                </div>
                                
                                <div class="mb-6">
                                    <h4 class="text-sm font-bold text-slate-400 mb-2 uppercase tracking-wider">DEFENDERS (4)</h4>
                                    <div class="grid grid-cols-2 gap-2">
                                        ${[1, 2, 3, 4].map(index => renderSlotCard(index)).join('')}
                                    </div>
                                </div>
                                
                                <div class="mb-6">
                                    <h4 class="text-sm font-bold text-slate-400 mb-2 uppercase tracking-wider">MIDFIELDERS (3)</h4>
                                    <div class="grid grid-cols-3 gap-2">
                                        ${[5, 6, 7].map(index => renderSlotCard(index)).join('')}
                                    </div>
                                </div>
                                
                                <div class="mb-6">
                                    <h4 class="text-sm font-bold text-slate-400 mb-2 uppercase tracking-wider">FORWARDS (3)</h4>
                                    <div class="grid grid-cols-3 gap-2">
                                        ${[8, 9, 10].map(index => renderSlotCard(index)).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="glass-panel rounded-xl flex flex-col h-full overflow-hidden border-t-4 border-t-slate-500">
                            <div class="p-4 bg-slate-900/50 border-b border-slate-700">
                                <h3 class="font-bold text-slate-300">Bench & Reserves</h3>
                                <div class="text-xs text-slate-500 mt-1">Available players not in Starting XI</div>
                            </div>
                            <div class="overflow-y-auto p-2 space-y-1 flex-grow">
                                ${benchPlayers.sort((a,b) => b.rating - a.rating).map(p => renderPlayerRow(p)).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }

            if (STATE.view === 'table') {
                const sorted = [...STATE.activeLeagueTeams].sort((a, b) => b.points - a.points || b.gd - a.gd || b.gf - a.gf);
                return `
                    <div class="glass-panel rounded-xl overflow-hidden">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-800 text-xs uppercase text-slate-400">
                                <tr>
                                    <th class="px-6 py-4 text-center">#</th>
                                    <th class="px-6 py-4">Club</th>
                                    <th class="px-6 py-4 text-center">P</th>
                                    <th class="px-6 py-4 text-center">W</th>
                                    <th class="px-6 py-4 text-center">D</th>
                                    <th class="px-6 py-4 text-center">L</th>
                                    <th class="px-6 py-4 text-center font-bold text-white">Pts</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-700/50">
                                ${sorted.map((t, i) => {
                                    let zoneClass = '';
                                    if (i < 4) zoneClass = 'border-l-4 border-emerald-500';
                                    else if (i < 6) zoneClass = 'border-l-4 border-blue-500';
                                    else if (i >= sorted.length - 3) zoneClass = 'border-l-4 border-red-500';
                                    
                                    const rowClass = t.id === STATE.userTeamId ? 'bg-[#4caf50]/10 border-l-4 border-[#4caf50] relative z-10 shadow-lg' : `hover:bg-slate-800/30 ${zoneClass}`;
                                    
                                    return `
                                    <tr class="${rowClass}">
                                        <td class="px-6 py-4 text-center text-slate-500 font-mono">${i+1}</td>
                                        <td class="px-6 py-4 font-bold text-slate-200 flex items-center gap-3">
                                            <div class="w-2 h-2 rounded-full" style="background-color:${t.color}"></div> ${t.name}
                                        </td>
                                        <td class="px-6 py-4 text-center text-slate-400">${t.played}</td>
                                        <td class="px-6 py-4 text-center text-[#4caf50]">${t.wins}</td>
                                        <td class="px-6 py-4 text-center text-slate-400">${t.draws}</td>
                                        <td class="px-6 py-4 text-center text-red-400">${t.losses}</td>
                                        <td class="px-6 py-4 text-center font-black text-white text-base">${t.points}</td>
                                    </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            if (STATE.view === 'squad') {
                const sortedSquad = [...userTeam.squad].sort((a, b) => {
                    if (b.seasonGoals !== a.seasonGoals) return b.seasonGoals - a.seasonGoals;
                    if (b.seasonAssists !== a.seasonAssists) return b.seasonAssists - a.seasonAssists;
                    return b.rating - a.rating;
                });
                
                return `
                    <div class="glass-panel rounded-xl overflow-hidden">
                        <div class="p-4 bg-slate-800/80 border-b border-slate-700 flex justify-between items-center">
                            <h3 class="font-bold text-white">Squad Statistics</h3>
                            <div class="flex gap-4 text-sm">
                                <div class="text-center">
                                    <div class="text-xl font-black text-[#4caf50]">${sortedSquad.reduce((sum, p) => sum + p.seasonGoals, 0)}</div>
                                    <div class="text-xs text-slate-400">Team Goals</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-xl font-black text-blue-400">${sortedSquad.reduce((sum, p) => sum + p.seasonAssists, 0)}</div>
                                    <div class="text-xs text-slate-400">Team Assists</div>
                                </div>
                            </div>
                        </div>
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-900 text-xs uppercase text-slate-400">
                                <tr>
                                    <th class="px-6 py-4">Name</th>
                                    <th class="px-6 py-4 text-center">Pos</th>
                                    <th class="px-6 py-4 text-center">OVR</th>
                                    <th class="px-6 py-4 text-center">POT</th>
                                    <th class="px-6 py-4 text-center">Status</th>
                                    <th class="px-6 py-4 text-center text-[#4caf50]">⚽ Goals</th>
                                    <th class="px-6 py-4 text-center text-blue-400">🎯 Assists</th>
                                    <th class="px-6 py-4 text-center text-yellow-400">⭐ Rating</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-700/50">
                                ${sortedSquad.map(p => `
                                    <tr class="hover:bg-slate-800/30">
                                        <td class="px-6 py-3 font-medium text-slate-200">
                                            <span class="clickable-name" onclick="openPlayerProfile(${p.internalId})">${p.name}</span>
                                            ${p.isStarter ? '<span class="ml-2 text-xs bg-[#4caf50] text-white px-2 py-0.5 rounded">STARTER</span>' : ''}
                                        </td>
                                        <td class="px-6 py-3 text-center"><span class="px-2 py-0.5 rounded text-xs font-bold ${getPosColor(p.pos)} bg-opacity-10">${p.pos}</span></td>
                                        <td class="px-6 py-3 text-center font-bold ${p.rating >= 85 ? 'text-yellow-400' : 'text-white'}">${p.rating}</td>
                                        <td class="px-6 py-3 text-center font-bold ${p.potential > p.rating ? 'text-emerald-400' : p.potential < p.rating ? 'text-red-400' : 'text-slate-400'}">${p.potential || p.rating}</td>
                                        <td class="px-6 py-3 text-center text-xs">
                                            ${p.transferListed ? '<span class="text-red-400 font-bold uppercase border border-red-500/30 px-2 py-1 rounded">Listed</span>' : ''}
                                            ${p.injuryWeeks > 0 ? `<span class="text-red-500 font-bold ml-1">🩹 ${p.injuryWeeks}w</span>` : ''}
                                            ${p.isSuspended ? '<span class="text-red-500 font-bold ml-1">🟥</span>' : ''}
                                            ${!p.transferListed && p.injuryWeeks === 0 && !p.isSuspended ? '<span class="text-slate-500">-</span>' : ''}
                                        </td>
                                        <td class="px-6 py-3 text-center">
                                            <div class="font-mono text-[#4caf50] font-bold text-lg">${p.seasonGoals}</div>
                                            <div class="text-xs text-slate-400">${p.careerGoals} career</div>
                                        </td>
                                        <td class="px-6 py-3 text-center">
                                            <div class="font-mono text-blue-400 font-bold text-lg">${p.seasonAssists}</div>
                                            <div class="text-xs text-slate-400">this season</div>
                                        </td>
                                        <td class="px-6 py-3 text-center">
                                            <div class="font-mono text-yellow-400 font-bold text-lg">${Math.round(p.seasonRating)}</div>
                                            <div class="text-xs text-slate-400">form</div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
        }

        function renderSlotCard(slotIndex) {
            const slotPositions = getSlotPositions();
            const slotPosition = slotPositions[slotIndex];
            const player = getPlayerInSlot(slotIndex);
            
            if (!player) {
                return `
                    <div class="empty-slot p-4 rounded-lg flex flex-col items-center justify-center text-center min-h-[100px]"
                         onclick="openSlotSelection(${slotIndex})">
                        <div class="text-3xl text-slate-600 mb-2">+</div>
                        <div class="slot-placeholder font-bold">EMPTY ${slotPosition.position}</div>
                        <div class="text-xs text-slate-500 mt-1">Click to select player</div>
                    </div>
                `;
            }
            
            const isUnavailable = player.injuryWeeks > 0 || player.isSuspended;
            
            return `
                <div class="player-card-select flex items-center justify-between p-3 rounded-lg bg-slate-800/40 ${isUnavailable ? 'unavailable' : ''}">
                    <div class="flex items-center gap-3">
                        <span class="text-[10px] font-black w-10 text-center py-1 rounded ${getPosColor(player.pos)} bg-opacity-10 ring-1 ring-inset ring-white/10 uppercase">
                            ${player.pos}
                        </span>
                        <div class="flex flex-col">
                            <span class="font-medium text-slate-200 clickable-name" onclick="openPlayerProfile(${player.internalId}, event)">${player.name}</span>
                            <span class="text-xs text-slate-500">Age: ${player.age} • POT: ${player.potential || player.rating}</span>
                            ${player.injuryWeeks > 0 ? `<span class="text-[10px] text-red-400 font-bold">🩹 Injured (${player.injuryWeeks} wks)</span>` : ''}
                            ${player.isSuspended ? `<span class="text-[10px] text-red-400 font-bold">🟥 Suspended</span>` : ''}
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        ${player.seasonGoals > 0 ? `<span class="text-xs font-bold text-[#4caf50]">⚽ ${player.seasonGoals}</span>` : ''}
                        ${player.seasonAssists > 0 ? `<span class="text-xs font-bold text-blue-400">🎯 ${player.seasonAssists}</span>` : ''}
                        <div class="font-bold ${player.rating >= 90 ? 'text-yellow-400' : 'text-slate-500'}">${player.rating}</div>
                        <button onclick="clearSlot(${slotIndex}); event.stopPropagation();" 
                                class="text-slate-500 hover:text-red-400 text-xs ml-2">
                            ✕
                        </button>
                    </div>
                </div>
            `;
        }

        function renderPlayerRow(p) {
            const isSelected = STATE.swapSelection === p.internalId;
            const isUnavailable = p.injuryWeeks > 0 || p.isSuspended;
            
            const potentialColor = p.potential > p.rating ? 'text-emerald-400' : 
                                 p.potential < p.rating ? 'text-red-400' : 'text-slate-400';
            
            return `
                <div onclick="handlePlayerSelect(${p.internalId})" 
                     class="player-card-select flex items-center justify-between p-3 rounded-lg ${isSelected ? 'selected' : 'bg-slate-800/40'} ${isUnavailable ? 'unavailable' : ''}">
                    <div class="flex items-center gap-3">
                        <span class="text-[10px] font-black w-10 text-center py-1 rounded ${getPosColor(p.pos)} bg-opacity-10 ring-1 ring-inset ring-white/10 uppercase">
                            ${p.pos}
                        </span>
                        <div class="flex flex-col">
                            <span class="font-medium text-slate-200 clickable-name" onclick="openPlayerProfile(${p.internalId}, event)">${p.name}</span>
                            <span class="text-xs text-slate-500">Age: ${p.age} • <span class="${potentialColor}">POT: ${p.potential || p.rating}</span></span>
                            ${p.injuryWeeks > 0 ? `<span class="text-[10px] text-red-400 font-bold">🩹 Injured (${p.injuryWeeks} wks)</span>` : ''}
                            ${p.isSuspended ? `<span class="text-[10px] text-red-400 font-bold">🟥 Suspended</span>` : ''}
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        ${p.seasonGoals > 0 ? `<span class="text-xs font-bold text-[#4caf50]">⚽ ${p.seasonGoals}</span>` : ''}
                        ${p.seasonAssists > 0 ? `<span class="text-xs font-bold text-blue-400">🎯 ${p.seasonAssists}</span>` : ''}
                        <div class="font-bold ${p.rating >= 90 ? 'text-yellow-400' : 'text-slate-500'}">${p.rating}</div>
                    </div>
                </div>
            `;
        }

        function getPosColor(pos) {
            const cat = getPosCategory(pos);
            if (cat === 1) return 'text-yellow-500 bg-yellow-500';
            if (cat === 2) return 'text-blue-400 bg-blue-400';
            if (cat === 3) return 'text-emerald-400 bg-emerald-400';
            return 'text-red-400 bg-red-400';
        }

        function handleMarketSearch(event) {
            STATE.market.search = event.target.value;
            STATE.market.page = 1;
            renderDashboard();
        }

        function clearMarketSearch() {
            STATE.market.search = '';
            STATE.market.page = 1;
            renderDashboard();
        }

        function changeMarketPage(page) {
            const totalPlayers = getFilteredMarketPlayers().length;
            const totalPages = Math.ceil(totalPlayers / STATE.market.perPage);
            if (page >= 1 && page <= totalPages) {
                STATE.market.page = page;
                renderDashboard();
            }
        }

        function getFilteredMarketPlayers() {
            const userTeam = getTeam(STATE.userTeamId);
            let players = [];
            for(const t of STATE.allTeams) {
                if(t.id === userTeam.id) continue;
                for(const p of t.squad) {
                    let match = true;
                    if (STATE.market.posFilter !== 'ALL') {
                        const cat = getPosCategory(p.pos);
                        if (STATE.market.posFilter === 'GK' && cat !== 1) match = false;
                        else if (STATE.market.posFilter === 'DEF' && cat !== 2) match = false;
                        else if (STATE.market.posFilter === 'MID' && cat !== 3) match = false;
                        else if (STATE.market.posFilter === 'FWD' && cat !== 4) match = false;
                    }
                    
                    if (STATE.market.search.trim() !== '') {
                        const searchTerm = STATE.market.search.toLowerCase().trim();
                        const playerName = p.name.toLowerCase();
                        if (!playerName.includes(searchTerm)) {
                            match = false;
                        }
                    }
                    
                    if(match) players.push(p);
                }
            }

            if (STATE.market.sort === 'RATING') players.sort((a,b) => b.rating - a.rating);
            else if (STATE.market.sort === 'PRICE') players.sort((a,b) => b.price - a.price);
            
            return players;
        }

        function showOfferModal(offer, onComplete) {
            const overlay = document.getElementById('offer-overlay');
            const body = document.getElementById('offer-body');
            const btnAccept = document.getElementById('btn-accept');
            const btnReject = document.getElementById('btn-reject');
            
            overlay.classList.remove('hidden');
            body.innerHTML = `
                <p class="text-slate-300 mb-2">An offer has been received for</p>
                <h4 class="text-xl font-black text-white mb-4">${offer.player.name}</h4>
                <div class="bg-slate-900 rounded-lg p-4 mb-4">
                    <div class="text-sm text-slate-400 uppercase font-bold">Offer From</div>
                    <div class="text-white font-bold mb-3">${offer.buyer.name}</div>
                    <div class="text-sm text-slate-400 uppercase font-bold">Amount</div>
                    <div class="text-2xl text-[#4caf50] font-black">${formatMoney(offer.price)}</div>
                </div>
                <p class="text-xs text-slate-500">Market Value: ${formatMoney(offer.player.price)}</p>
            `;

            btnAccept.onclick = () => {
                transferPlayer(offer.player, getTeam(STATE.userTeamId), offer.buyer, offer.price);
                addNews('Transfer News', `Sold ${offer.player.name} to ${offer.buyer.name} for ${formatMoney(offer.price)}`, 'transfer');
                overlay.classList.add('hidden');
                onComplete();
            };

            btnReject.onclick = () => {
                overlay.classList.add('hidden');
                onComplete();
            };
        }

        function showResultsModal(results, onContinue) {
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            overlay.classList.remove('hidden');

            const userRes = results.find(r => r.homeId === STATE.userTeamId || r.awayId === STATE.userTeamId);
            const others = results.filter(r => r !== userRes);

            let mainHtml = '';
            if (userRes) {
                const h = getTeam(userRes.homeId);
                const a = getTeam(userRes.awayId);
                const s = userRes.stats;
                
                const getScorerHtml = (arr) => arr.map(p => 
                    `<div class="clickable-name hover:text-[#4caf50]" onclick="openPlayerProfile(${p.internalId})">${p.name} <span class="text-slate-500 text-[10px]">(${p.pos})</span></div>`
                ).join('');

                const redCardsInfo = s.redCardsHome > 0 || s.redCardsAway > 0 ? `
                    <div class="mt-4 pt-4 border-t border-slate-700">
                        <div class="flex justify-between text-xs">
                            <span class="${s.redCardsHome > 0 ? 'text-red-400 font-bold' : 'text-slate-500'}">
                                ${s.redCardsHome > 0 ? `🟥 ${s.redCardsHome} red card${s.redCardsHome > 1 ? 's' : ''}` : 'No red cards'}
                            </span>
                            <span class="text-slate-500">Red Cards</span>
                            <span class="${s.redCardsAway > 0 ? 'text-red-400 font-bold' : 'text-slate-500'}">
                                ${s.redCardsAway > 0 ? `🟥 ${s.redCardsAway} red card${s.redCardsAway > 1 ? 's' : ''}` : 'No red cards'}
                            </span>
                        </div>
                    </div>
                ` : '';

                mainHtml = `
                    <div class="bg-slate-900 p-6 border-b border-slate-700">
                        <div class="flex justify-between items-center mb-4">
                            <div class="text-center w-1/3">
                                <div class="font-black text-xl text-white mb-2 leading-none">${h.name}</div>
                                <div class="text-xs text-slate-400 space-y-1">${getScorerHtml(s.scorersHome.filter(p => !p.isAssist))}</div>
                            </div>
                            <div class="bg-black border border-slate-700 rounded-lg px-5 py-2 text-3xl font-black text-[#4caf50]">
                                ${userRes.homeGoals} - ${userRes.awayGoals}
                            </div>
                            <div class="text-center w-1/3">
                                <div class="font-black text-xl text-white mb-2 leading-none">${a.name}</div>
                                <div class="text-xs text-slate-400 space-y-1">${getScorerHtml(s.scorersAway.filter(p => !p.isAssist))}</div>
                            </div>
                        </div>
                        
                        <div class="space-y-2 mt-6">
                            <div class="flex justify-between text-xs text-slate-500 font-bold uppercase">
                                <span>${s.possHome}%</span> <span>Possession</span> <span>${s.possAway}%</span>
                            </div>
                            <div class="flex h-1.5 bg-slate-800 rounded-full overflow-hidden">
                                <div class="bg-[#4caf50]" style="width:${s.possHome}%"></div>
                                <div class="bg-slate-600 flex-grow"></div>
                            </div>
                            <div class="flex justify-between text-xs text-slate-500 font-bold uppercase mt-2">
                                <span>${s.shotsHome}</span> <span>Shots</span> <span>${s.shotsAway}</span>
                            </div>
                            <div class="flex h-1.5 bg-slate-800 rounded-full overflow-hidden">
                                <div class="bg-blue-400" style="width:${(s.shotsHome/(s.shotsHome+s.shotsAway))*100}%"></div>
                                <div class="bg-red-400 flex-grow"></div>
                            </div>
                            ${redCardsInfo}
                        </div>
                    </div>
                `;
            }

            content.innerHTML = `
                ${mainHtml}
                <div class="flex-grow overflow-y-auto bg-slate-800 p-4 space-y-1">
                    <h4 class="text-xs font-bold text-slate-500 uppercase mb-2">Other Results</h4>
                    ${others.map(r => {
                        const h = getTeam(r.homeId);
                        const a = getTeam(r.awayId);
                        return `
                            <div class="flex justify-between text-sm py-2 border-b border-slate-700/50 last:border-0">
                                <span class="text-right w-5/12 truncate text-slate-300">${h.name}</span>
                                <span class="text-center font-bold text-white bg-slate-700 px-2 rounded">${r.homeGoals}-${r.awayGoals}</span>
                                <span class="text-left w-5/12 truncate text-slate-300">${a.name}</span>
                            </div>
                        `
                    }).join('')}
                </div>
                <div class="p-4 bg-slate-900 border-t border-slate-700">
                    <button id="modal-continue-btn" class="w-full bg-[#4caf50] hover:bg-[#43a047] text-white font-bold py-3 rounded-lg uppercase tracking-wider">Continue</button>
                </div>
            `;

            document.getElementById('modal-continue-btn').onclick = () => {
                document.getElementById('modal-overlay').classList.add('hidden');
                if (onContinue) onContinue();
            };
        }

        // Мобильные функции
        function toggleMobileNav() {
            document.body.classList.toggle('nav-open');
        }

        function closeMobileNav() {
            document.body.classList.remove('nav-open');
        }

        document.addEventListener('click', function(event) {
            const playWeekBtn = event.target.closest('#playWeekBtn');
            if (playWeekBtn) {
                event.preventDefault();
                event.stopPropagation();
                
                const isFinished = STATE.currentWeek >= STATE.schedule.length;
                if (isFinished) {
                    return;
                }
                
                const userTeam = getTeam(STATE.userTeamId);
                if (userTeam) {
                    const validation = validateStartingXI(userTeam);
                    if (!validation.valid) {
                        alert(validation.message);
                        return;
                    }
                }
                
                playWeek();
            }
        });
        
        renderUploadScreen();

    </script>
</body>
</html>